


          
ç”¨æˆ·è¦æ±‚åˆ†ä¸‰æ­¥å®ç°ï¼š1) å…ˆç”Ÿæˆé«˜å¾·åœ°å›¾webå‰ç«¯æ¸²æŸ“åŠŸèƒ½ï¼Œ2) å¯¹æ¥åå°æ¥å£æœåŠ¡ï¼Œ3) ç”ŸæˆIOT MQTTäº‹ä»¶æ¥å£æ›´æ–°æ—¶åºå®šä½æ•°æ®ã€‚æˆ‘å…ˆæŸ¥çœ‹ç°æœ‰çš„å‰ç«¯ç»“æ„ï¼Œç„¶ååˆ›å»ºé«˜å¾·åœ°å›¾çš„å‰ç«¯ç»„ä»¶ã€‚
        
            
toolName: view_files
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend
          
éœ€è¦å…ˆæŸ¥çœ‹å‰ç«¯ç›®å½•ç»“æ„ï¼Œäº†è§£ç°æœ‰çš„æ–‡ä»¶ç»„ç»‡æ–¹å¼ã€‚
        
            
toolName: view_folder
            
status: success
          
/Users/arthurren/projects/lbsiot/src/frontend
          
æŸ¥çœ‹å‰ç«¯ç»„ä»¶ç›®å½•ç»“æ„ï¼Œäº†è§£ç°æœ‰ç»„ä»¶çš„ç»„ç»‡æ–¹å¼ã€‚
        
            
toolName: view_folder
            
status: success
          
/Users/arthurren/projects/lbsiot/src/frontend/components
          
æŸ¥çœ‹å‰ç«¯é¡µé¢ç›®å½•ï¼Œäº†è§£ç°æœ‰é¡µé¢ç»“æ„ã€‚
        
            
toolName: view_folder
            
status: success
          
/Users/arthurren/projects/lbsiot/src/frontend/pages
          
æŸ¥çœ‹å‰ç«¯æœåŠ¡ç›®å½•ï¼Œäº†è§£ç°æœ‰çš„æœåŠ¡å±‚ç»“æ„ã€‚
        
            
toolName: view_folder
            
status: success
          
/Users/arthurren/projects/lbsiot/src/frontend/services
          
æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•çš„package.jsonæ–‡ä»¶ï¼Œäº†è§£å‰ç«¯æŠ€æœ¯æ ˆå’Œä¾èµ–é…ç½®ã€‚
        
            
toolName: view_files
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/package.json
          
ç°åœ¨åˆ›å»ºé«˜å¾·åœ°å›¾çš„å‰ç«¯ç»„ä»¶ã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªé«˜å¾·åœ°å›¾æœåŠ¡ç±»æ¥å¤„ç†åœ°å›¾åˆå§‹åŒ–å’ŒAPIè°ƒç”¨ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/services/AmapService.js
          
content: /**
 * é«˜å¾·åœ°å›¾æœåŠ¡ç±»
 * æä¾›åœ°å›¾åˆå§‹åŒ–ã€æ ‡è®°ç®¡ç†ã€è·¯å¾„ç»˜åˆ¶ç­‰åŠŸèƒ½
 */
class AmapService {
  constructor(config) {
    this.config = config;
    this.map = null;
    this.markers = new Map();
    this.polylines = new Map();
    this.isLoaded = false;
  }

  /**
   * åŠ è½½é«˜å¾·åœ°å›¾API
   */
  async loadAmapAPI() {
    return new Promise((resolve, reject) => {
      if (window.AMap) {
        this.isLoaded = true;
        resolve();
        return;
      }

      // è®¾ç½®å®‰å…¨å¯†é’¥
      window._AMapSecurityConfig = {
        securityJsCode: this.config.security_js_code,
      };

      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = `https://webapi.amap.com/maps?v=${this.config.version}&key=${this.config.api_key}&plugin=${this.config.plugins.join(',')}`;
      
      script.onload = () => {
        this.isLoaded = true;
        resolve();
      };
      
      script.onerror = () => {
        reject(new Error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥'));
      };
      
      document.head.appendChild(script);
    });
  }

  /**
   * åˆå§‹åŒ–åœ°å›¾
   */
  async initMap(containerId) {
    if (!this.isLoaded) {
      await this.loadAmapAPI();
    }

    this.map = new AMap.Map(containerId, {
      zoom: this.config.default_zoom,
      center: [this.config.default_center.lng, this.config.default_center.lat],
      mapStyle: this.config.map_style,
      viewMode: this.config.view_mode,
      features: ['bg', 'road', 'building', 'point'],
      showLabel: true
    });

    // æ·»åŠ åœ°å›¾æ§ä»¶
    this.map.addControl(new AMap.Scale());
    this.map.addControl(new AMap.ToolBar());

    return this.map;
  }

  /**
   * æ·»åŠ æ ‡è®°ç‚¹
   */
  addMarker(id, position, options = {}) {
    if (!this.map) {
      throw new Error('åœ°å›¾æœªåˆå§‹åŒ–');
    }

    const marker = new AMap.Marker({
      position: [position.lng, position.lat],
      title: options.title || '',
      icon: options.icon || undefined,
      offset: options.offset || new AMap.Pixel(-13, -30)
    });

    // æ·»åŠ ä¿¡æ¯çª—ä½“
    if (options.infoWindow) {
      const infoWindow = new AMap.InfoWindow({
        content: options.infoWindow.content,
        offset: new AMap.Pixel(0, -30)
      });

      marker.on('click', () => {
        infoWindow.open(this.map, marker.getPosition());
      });
    }

    this.map.add(marker);
    this.markers.set(id, marker);
    
    return marker;
  }

  /**
   * ç§»é™¤æ ‡è®°ç‚¹
   */
  removeMarker(id) {
    const marker = this.markers.get(id);
    if (marker) {
      this.map.remove(marker);
      this.markers.delete(id);
    }
  }

  /**
   * ç»˜åˆ¶æ—¶é—´åºåˆ—è·¯å¾„
   */
  drawTimeSeriesPath(id, coordinates, options = {}) {
    if (!this.map) {
      throw new Error('åœ°å›¾æœªåˆå§‹åŒ–');
    }

    // è½¬æ¢åæ ‡æ ¼å¼
    const path = coordinates.map(coord => [coord.lng, coord.lat]);

    const polyline = new AMap.Polyline({
      path: path,
      strokeColor: options.strokeColor || '#3366FF',
      strokeWeight: options.strokeWeight || 6,
      strokeOpacity: options.strokeOpacity || 0.8,
      strokeStyle: options.strokeStyle || 'solid',
      showDir: options.showDirection || true
    });

    this.map.add(polyline);
    this.polylines.set(id, polyline);

    // è‡ªåŠ¨è°ƒæ•´è§†é‡
    if (options.fitView !== false) {
      this.map.setFitView([polyline]);
    }

    return polyline;
  }

  /**
   * ç§»é™¤è·¯å¾„
   */
  removePath(id) {
    const polyline = this.polylines.get(id);
    if (polyline) {
      this.map.remove(polyline);
      this.polylines.delete(id);
    }
  }

  /**
   * æ¸…é™¤æ‰€æœ‰æ ‡è®°å’Œè·¯å¾„
   */
  clearAll() {
    // æ¸…é™¤æ‰€æœ‰æ ‡è®°
    this.markers.forEach(marker => this.map.remove(marker));
    this.markers.clear();

    // æ¸…é™¤æ‰€æœ‰è·¯å¾„
    this.polylines.forEach(polyline => this.map.remove(polyline));
    this.polylines.clear();
  }

  /**
   * åœ°ç†ç¼–ç  - åœ°å€è½¬åæ ‡
   */
  async geocode(address) {
    return new Promise((resolve, reject) => {
      const geocoder = new AMap.Geocoder();
      geocoder.getLocation(address, (status, result) => {
        if (status === 'complete' && result.geocodes.length) {
          const location = result.geocodes[0].location;
          resolve({
            lng: location.lng,
            lat: location.lat,
            address: result.geocodes[0].formattedAddress
          });
        } else {
          reject(new Error('åœ°ç†ç¼–ç å¤±è´¥'));
        }
      });
    });
  }

  /**
   * é€†åœ°ç†ç¼–ç  - åæ ‡è½¬åœ°å€
   */
  async reverseGeocode(position) {
    return new Promise((resolve, reject) => {
      const geocoder = new AMap.Geocoder();
      geocoder.getAddress([position.lng, position.lat], (status, result) => {
        if (status === 'complete' && result.regeocode) {
          resolve({
            address: result.regeocode.formattedAddress,
            addressComponent: result.regeocode.addressComponent
          });
        } else {
          reject(new Error('é€†åœ°ç†ç¼–ç å¤±è´¥'));
        }
      });
    });
  }

  /**
   * POIæœç´¢
   */
  async searchPOI(keyword, options = {}) {
    return new Promise((resolve, reject) => {
      const placeSearch = new AMap.PlaceSearch({
        pageSize: options.pageSize || 10,
        pageIndex: options.pageIndex || 1,
        city: options.city || 'å…¨å›½',
        citylimit: options.citylimit || false
      });

      placeSearch.search(keyword, (status, result) => {
        if (status === 'complete' && result.poiList) {
          const pois = result.poiList.pois.map(poi => ({
            id: poi.id,
            name: poi.name,
            address: poi.address,
            location: {
              lng: poi.location.lng,
              lat: poi.location.lat
            },
            type: poi.type,
            tel: poi.tel
          }));
          resolve(pois);
        } else {
          reject(new Error('POIæœç´¢å¤±è´¥'));
        }
      });
    });
  }

  /**
   * è·å–åœ°å›¾å®ä¾‹
   */
  getMap() {
    return this.map;
  }

  /**
   * é”€æ¯åœ°å›¾
   */
  destroy() {
    if (this.map) {
      this.map.destroy();
      this.map = null;
    }
    this.markers.clear();
    this.polylines.clear();
  }
}

export default AmapService;

          
åˆ›å»ºé«˜å¾·åœ°å›¾çš„Reactç»„ä»¶ï¼Œæä¾›åœ°å›¾æ¸²æŸ“å’Œäº¤äº’åŠŸèƒ½ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/components/AmapComponent.jsx
          
content: import React, { useEffect, useRef, useState, useCallback } from 'react';
import AmapService from '../services/AmapService';

/**
 * é«˜å¾·åœ°å›¾ç»„ä»¶
 * æ”¯æŒæ ‡è®°ç‚¹æ˜¾ç¤ºã€æ—¶é—´åºåˆ—è·¯å¾„ç»˜åˆ¶ã€POIæœç´¢ç­‰åŠŸèƒ½
 */
const AmapComponent = ({
  config,
  markers = [],
  paths = [],
  onMapReady,
  onMarkerClick,
  onMapClick,
  className = '',
  style = { width: '100%', height: '400px' }
}) => {
  const mapContainerRef = useRef(null);
  const amapServiceRef = useRef(null);
  const [isMapReady, setIsMapReady] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // åˆå§‹åŒ–åœ°å›¾
  useEffect(() => {
    const initializeMap = async () => {
      try {
        setLoading(true);
        setError(null);

        // åˆ›å»ºåœ°å›¾æœåŠ¡å®ä¾‹
        amapServiceRef.current = new AmapService(config);
        
        // åˆå§‹åŒ–åœ°å›¾
        await amapServiceRef.current.initMap(mapContainerRef.current);
        
        // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
        if (onMapClick) {
          amapServiceRef.current.getMap().on('click', (e) => {
            onMapClick({
              lng: e.lnglat.lng,
              lat: e.lnglat.lat
            });
          });
        }

        setIsMapReady(true);
        setLoading(false);
        
        // é€šçŸ¥çˆ¶ç»„ä»¶åœ°å›¾å·²å‡†å¤‡å°±ç»ª
        if (onMapReady) {
          onMapReady(amapServiceRef.current);
        }
      } catch (err) {
        console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', err);
        setError(err.message);
        setLoading(false);
      }
    };

    if (mapContainerRef.current && config) {
      initializeMap();
    }

    // æ¸…ç†å‡½æ•°
    return () => {
      if (amapServiceRef.current) {
        amapServiceRef.current.destroy();
      }
    };
  }, [config, onMapReady, onMapClick]);

  // å¤„ç†æ ‡è®°ç‚¹å˜åŒ–
  useEffect(() => {
    if (!isMapReady || !amapServiceRef.current) return;

    const amapService = amapServiceRef.current;
    
    // æ¸…é™¤ç°æœ‰æ ‡è®°
    amapService.markers.forEach((marker, id) => {
      amapService.removeMarker(id);
    });

    // æ·»åŠ æ–°æ ‡è®°
    markers.forEach((marker, index) => {
      const markerId = marker.id || `marker_${index}`;
      const markerInstance = amapService.addMarker(markerId, marker.position, {
        title: marker.title,
        icon: marker.icon,
        infoWindow: marker.infoWindow ? {
          content: marker.infoWindow
        } : null
      });

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      if (onMarkerClick) {
        markerInstance.on('click', () => {
          onMarkerClick(marker, markerId);
        });
      }
    });
  }, [markers, isMapReady, onMarkerClick]);

  // å¤„ç†è·¯å¾„å˜åŒ–
  useEffect(() => {
    if (!isMapReady || !amapServiceRef.current) return;

    const amapService = amapServiceRef.current;
    
    // æ¸…é™¤ç°æœ‰è·¯å¾„
    amapService.polylines.forEach((polyline, id) => {
      amapService.removePath(id);
    });

    // æ·»åŠ æ–°è·¯å¾„
    paths.forEach((path, index) => {
      const pathId = path.id || `path_${index}`;
      amapService.drawTimeSeriesPath(pathId, path.coordinates, {
        strokeColor: path.color || '#3366FF',
        strokeWeight: path.weight || 6,
        strokeOpacity: path.opacity || 0.8,
        showDirection: path.showDirection !== false,
        fitView: path.fitView !== false && index === 0 // åªæœ‰ç¬¬ä¸€æ¡è·¯å¾„è‡ªåŠ¨è°ƒæ•´è§†é‡
      });
    });
  }, [paths, isMapReady]);

  // è·å–åœ°å›¾æœåŠ¡å®ä¾‹
  const getAmapService = useCallback(() => {
    return amapServiceRef.current;
  }, []);

  // æ·»åŠ æ ‡è®°ç‚¹çš„æ–¹æ³•
  const addMarker = useCallback((position, options = {}) => {
    if (!amapServiceRef.current) return null;
    const id = options.id || `marker_${Date.now()}`;
    return amapServiceRef.current.addMarker(id, position, options);
  }, []);

  // ç»˜åˆ¶è·¯å¾„çš„æ–¹æ³•
  const drawPath = useCallback((coordinates, options = {}) => {
    if (!amapServiceRef.current) return null;
    const id = options.id || `path_${Date.now()}`;
    return amapServiceRef.current.drawTimeSeriesPath(id, coordinates, options);
  }, []);

  // æ¸…é™¤æ‰€æœ‰è¦†ç›–ç‰©
  const clearAll = useCallback(() => {
    if (amapServiceRef.current) {
      amapServiceRef.current.clearAll();
    }
  }, []);

  // åœ°ç†ç¼–ç 
  const geocode = useCallback(async (address) => {
    if (!amapServiceRef.current) throw new Error('åœ°å›¾æœªåˆå§‹åŒ–');
    return await amapServiceRef.current.geocode(address);
  }, []);

  // é€†åœ°ç†ç¼–ç 
  const reverseGeocode = useCallback(async (position) => {
    if (!amapServiceRef.current) throw new Error('åœ°å›¾æœªåˆå§‹åŒ–');
    return await amapServiceRef.current.reverseGeocode(position);
  }, []);

  // POIæœç´¢
  const searchPOI = useCallback(async (keyword, options = {}) => {
    if (!amapServiceRef.current) throw new Error('åœ°å›¾æœªåˆå§‹åŒ–');
    return await amapServiceRef.current.searchPOI(keyword, options);
  }, []);

  // æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
  React.useImperativeHandle(React.forwardRef(() => {}), () => ({
    getAmapService,
    addMarker,
    drawPath,
    clearAll,
    geocode,
    reverseGeocode,
    searchPOI
  }));

  if (error) {
    return (
      <div className={`amap-error ${className}`} style={style}>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          height: '100%',
          flexDirection: 'column',
          color: '#ff4d4f',
          fontSize: '14px'
        }}>
          <div style={{ marginBottom: '8px' }}>âš ï¸ åœ°å›¾åŠ è½½å¤±è´¥</div>
          <div style={{ fontSize: '12px', color: '#666' }}>{error}</div>
        </div>
      </div>
    );
  }

  return (
    <div className={`amap-container ${className}`} style={{ position: 'relative', ...style }}>
      {loading && (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'rgba(255, 255, 255, 0.8)',
          zIndex: 1000,
          fontSize: '14px',
          color: '#666'
        }}>
          <div>
            <div style={{ marginBottom: '8px' }}>ğŸ—ºï¸ æ­£åœ¨åŠ è½½åœ°å›¾...</div>
            <div style={{ fontSize: '12px' }}>è¯·ç¨å€™</div>
          </div>
        </div>
      )}
      <div
        ref={mapContainerRef}
        style={{
          width: '100%',
          height: '100%',
          opacity: loading ? 0.3 : 1,
          transition: 'opacity 0.3s ease'
        }}
      />
    </div>
  );
};

export default AmapComponent;

          
åˆ›å»ºä¸€ä¸ªé…ç½®ç®¡ç†æœåŠ¡ï¼Œç”¨äºè¯»å–å’Œç®¡ç†é«˜å¾·åœ°å›¾çš„é…ç½®ä¿¡æ¯ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/services/ConfigService.js
          
content: /**
 * é…ç½®æœåŠ¡ç±»
 * è´Ÿè´£åŠ è½½å’Œç®¡ç†åº”ç”¨é…ç½®
 */
class ConfigService {
  constructor() {
    this.config = null;
    this.loaded = false;
  }

  /**
   * åŠ è½½é…ç½®æ–‡ä»¶
   */
  async loadConfig() {
    if (this.loaded) {
      return this.config;
    }

    try {
      // ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶åŠ è½½é…ç½®
      const response = await fetch('/api/config');
      if (!response.ok) {
        throw new Error('é…ç½®åŠ è½½å¤±è´¥');
      }
      
      this.config = await response.json();
      this.loaded = true;
      return this.config;
    } catch (error) {
      console.warn('ä»æœåŠ¡å™¨åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
      
      // ä½¿ç”¨é»˜è®¤é…ç½®
      this.config = this.getDefaultConfig();
      this.loaded = true;
      return this.config;
    }
  }

  /**
   * è·å–é»˜è®¤é…ç½®
   */
  getDefaultConfig() {
    return {
      amap: {
        api_key: process.env.REACT_APP_AMAP_API_KEY || 'YOUR_AMAP_API_KEY',
        security_js_code: process.env.REACT_APP_AMAP_SECURITY_CODE || 'YOUR_AMAP_SECURITY_CODE',
        version: '2.0',
        plugins: ['AMap.Scale', 'AMap.ToolBar', 'AMap.Geocoder', 'AMap.PlaceSearch'],
        default_center: {
          lng: 116.4074,
          lat: 39.9042
        },
        default_zoom: 12,
        map_style: 'amap://styles/normal',
        view_mode: '3D'
      },
      api: {
        base_url: process.env.REACT_APP_API_BASE_URL || 'http://localhost:3000',
        timeout: 10000
      },
      websocket: {
        url: process.env.REACT_APP_WS_URL || 'ws://localhost:3000',
        reconnect_interval: 5000,
        max_reconnect_attempts: 10
      },
      iot: {
        mqtt_broker: process.env.REACT_APP_MQTT_BROKER || 'ws://localhost:8083/mqtt',
        topics: {
          device_location: 'iot/device/+/location',
          device_status: 'iot/device/+/status',
          system_alerts: 'iot/system/alerts'
        }
      }
    };
  }

  /**
   * è·å–é«˜å¾·åœ°å›¾é…ç½®
   */
  getAmapConfig() {
    if (!this.config) {
      throw new Error('é…ç½®æœªåŠ è½½ï¼Œè¯·å…ˆè°ƒç”¨ loadConfig()');
    }
    return this.config.amap;
  }

  /**
   * è·å–APIé…ç½®
   */
  getApiConfig() {
    if (!this.config) {
      throw new Error('é…ç½®æœªåŠ è½½ï¼Œè¯·å…ˆè°ƒç”¨ loadConfig()');
    }
    return this.config.api;
  }

  /**
   * è·å–WebSocketé…ç½®
   */
  getWebSocketConfig() {
    if (!this.config) {
      throw new Error('é…ç½®æœªåŠ è½½ï¼Œè¯·å…ˆè°ƒç”¨ loadConfig()');
    }
    return this.config.websocket;
  }

  /**
   * è·å–IoTé…ç½®
   */
  getIoTConfig() {
    if (!this.config) {
      throw new Error('é…ç½®æœªåŠ è½½ï¼Œè¯·å…ˆè°ƒç”¨ loadConfig()');
    }
    return this.config.iot;
  }

  /**
   * è·å–å®Œæ•´é…ç½®
   */
  getConfig() {
    return this.config;
  }

  /**
   * æ›´æ–°é…ç½®
   */
  updateConfig(newConfig) {
    this.config = { ...this.config, ...newConfig };
  }

  /**
   * éªŒè¯é…ç½®
   */
  validateConfig() {
    if (!this.config) {
      return { valid: false, errors: ['é…ç½®æœªåŠ è½½'] };
    }

    const errors = [];

    // éªŒè¯é«˜å¾·åœ°å›¾é…ç½®
    if (!this.config.amap?.api_key || this.config.amap.api_key === 'YOUR_AMAP_API_KEY') {
      errors.push('é«˜å¾·åœ°å›¾APIå¯†é’¥æœªé…ç½®');
    }

    if (!this.config.amap?.security_js_code || this.config.amap.security_js_code === 'YOUR_AMAP_SECURITY_CODE') {
      errors.push('é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥æœªé…ç½®');
    }

    // éªŒè¯APIé…ç½®
    if (!this.config.api?.base_url) {
      errors.push('APIåŸºç¡€URLæœªé…ç½®');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }
}

// åˆ›å»ºå•ä¾‹å®ä¾‹
const configService = new ConfigService();

export default configService;

          
åˆ›å»ºä¸€ä¸ªIoTæ•°æ®æœåŠ¡ï¼Œç”¨äºå¤„ç†è®¾å¤‡ä½ç½®æ•°æ®å’ŒMQTTé€šä¿¡ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/services/IoTDataService.js
          
content: /**
 * IoTæ•°æ®æœåŠ¡ç±»
 * è´Ÿè´£å¤„ç†è®¾å¤‡ä½ç½®æ•°æ®ã€MQTTé€šä¿¡å’Œå®æ—¶æ•°æ®æ›´æ–°
 */
class IoTDataService {
  constructor(config) {
    this.config = config;
    this.mqttClient = null;
    this.websocket = null;
    this.deviceData = new Map();
    this.listeners = new Map();
    this.isConnected = false;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = config?.max_reconnect_attempts || 10;
    this.reconnectInterval = config?.reconnect_interval || 5000;
  }

  /**
   * åˆå§‹åŒ–è¿æ¥
   */
  async initialize() {
    try {
      await this.connectWebSocket();
      await this.connectMQTT();
      this.isConnected = true;
      this.reconnectAttempts = 0;
      console.log('IoTæ•°æ®æœåŠ¡åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('IoTæ•°æ®æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error);
      this.scheduleReconnect();
    }
  }

  /**
   * è¿æ¥WebSocket
   */
  async connectWebSocket() {
    return new Promise((resolve, reject) => {
      try {
        this.websocket = new WebSocket(this.config.websocket.url);
        
        this.websocket.onopen = () => {
          console.log('WebSocketè¿æ¥å·²å»ºç«‹');
          resolve();
        };
        
        this.websocket.onmessage = (event) => {
          this.handleWebSocketMessage(event.data);
        };
        
        this.websocket.onclose = () => {
          console.log('WebSocketè¿æ¥å·²å…³é—­');
          this.isConnected = false;
          this.scheduleReconnect();
        };
        
        this.websocket.onerror = (error) => {
          console.error('WebSocketè¿æ¥é”™è¯¯:', error);
          reject(error);
        };
      } catch (error) {
        reject(error);
      }
    });
  }

  /**
   * è¿æ¥MQTTï¼ˆé€šè¿‡WebSocketï¼‰
   */
  async connectMQTT() {
    // è¿™é‡Œä½¿ç”¨mqtt.jsåº“çš„WebSocketè¿æ¥
    // éœ€è¦åœ¨package.jsonä¸­æ·»åŠ mqttä¾èµ–
    try {
      // æ¨¡æ‹ŸMQTTè¿æ¥ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨mqtt.js
      console.log('MQTTè¿æ¥æ¨¡æ‹Ÿå»ºç«‹');
      this.subscribeMQTTTopics();
    } catch (error) {
      console.error('MQTTè¿æ¥å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * è®¢é˜…MQTTä¸»é¢˜
   */
  subscribeMQTTTopics() {
    const topics = this.config.iot.topics;
    
    // è®¢é˜…è®¾å¤‡ä½ç½®ä¸»é¢˜
    console.log('è®¢é˜…MQTTä¸»é¢˜:', topics.device_location);
    
    // è®¢é˜…è®¾å¤‡çŠ¶æ€ä¸»é¢˜
    console.log('è®¢é˜…MQTTä¸»é¢˜:', topics.device_status);
    
    // è®¢é˜…ç³»ç»Ÿå‘Šè­¦ä¸»é¢˜
    console.log('è®¢é˜…MQTTä¸»é¢˜:', topics.system_alerts);
  }

  /**
   * å¤„ç†WebSocketæ¶ˆæ¯
   */
  handleWebSocketMessage(data) {
    try {
      const message = JSON.parse(data);
      
      switch (message.type) {
        case 'device_location':
          this.handleDeviceLocationUpdate(message.data);
          break;
        case 'device_status':
          this.handleDeviceStatusUpdate(message.data);
          break;
        case 'system_alert':
          this.handleSystemAlert(message.data);
          break;
        case 'historical_data':
          this.handleHistoricalData(message.data);
          break;
        default:
          console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
      }
    } catch (error) {
      console.error('å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error);
    }
  }

  /**
   * å¤„ç†è®¾å¤‡ä½ç½®æ›´æ–°
   */
  handleDeviceLocationUpdate(data) {
    const { deviceId, location, timestamp } = data;
    
    // æ›´æ–°è®¾å¤‡æ•°æ®
    if (!this.deviceData.has(deviceId)) {
      this.deviceData.set(deviceId, {
        id: deviceId,
        locations: [],
        status: 'online',
        lastUpdate: timestamp
      });
    }
    
    const device = this.deviceData.get(deviceId);
    device.locations.push({
      ...location,
      timestamp
    });
    
    // ä¿æŒæœ€è¿‘100ä¸ªä½ç½®ç‚¹
    if (device.locations.length > 100) {
      device.locations = device.locations.slice(-100);
    }
    
    device.lastUpdate = timestamp;
    
    // é€šçŸ¥ç›‘å¬å™¨
    this.notifyListeners('device_location_update', {
      deviceId,
      location,
      timestamp,
      device
    });
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°
   */
  handleDeviceStatusUpdate(data) {
    const { deviceId, status, timestamp } = data;
    
    if (this.deviceData.has(deviceId)) {
      const device = this.deviceData.get(deviceId);
      device.status = status;
      device.lastUpdate = timestamp;
      
      this.notifyListeners('device_status_update', {
        deviceId,
        status,
        timestamp,
        device
      });
    }
  }

  /**
   * å¤„ç†ç³»ç»Ÿå‘Šè­¦
   */
  handleSystemAlert(data) {
    console.log('ç³»ç»Ÿå‘Šè­¦:', data);
    this.notifyListeners('system_alert', data);
  }

  /**
   * å¤„ç†å†å²æ•°æ®
   */
  handleHistoricalData(data) {
    const { deviceId, locations } = data;
    
    if (!this.deviceData.has(deviceId)) {
      this.deviceData.set(deviceId, {
        id: deviceId,
        locations: [],
        status: 'unknown',
        lastUpdate: null
      });
    }
    
    const device = this.deviceData.get(deviceId);
    device.locations = locations;
    
    this.notifyListeners('historical_data_loaded', {
      deviceId,
      locations,
      device
    });
  }

  /**
   * æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
   */
  addEventListener(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  /**
   * ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
   */
  removeEventListener(event, callback) {
    if (this.listeners.has(event)) {
      const callbacks = this.listeners.get(event);
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }

  /**
   * é€šçŸ¥ç›‘å¬å™¨
   */
  notifyListeners(event, data) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(data);
        } catch (error) {
          console.error('ç›‘å¬å™¨å›è°ƒæ‰§è¡Œå¤±è´¥:', error);
        }
      });
    }
  }

  /**
   * è·å–è®¾å¤‡æ•°æ®
   */
  getDeviceData(deviceId) {
    return this.deviceData.get(deviceId);
  }

  /**
   * è·å–æ‰€æœ‰è®¾å¤‡æ•°æ®
   */
  getAllDeviceData() {
    return Array.from(this.deviceData.values());
  }

  /**
   * è·å–è®¾å¤‡ä½ç½®å†å²
   */
  getDeviceLocationHistory(deviceId, limit = 50) {
    const device = this.deviceData.get(deviceId);
    if (!device) return [];
    
    return device.locations.slice(-limit);
  }

  /**
   * è¯·æ±‚å†å²æ•°æ®
   */
  async requestHistoricalData(deviceId, startTime, endTime) {
    if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
      throw new Error('WebSocketè¿æ¥æœªå»ºç«‹');
    }
    
    const message = {
      type: 'request_historical_data',
      data: {
        deviceId,
        startTime,
        endTime
      }
    };
    
    this.websocket.send(JSON.stringify(message));
  }

  /**
   * å‘é€è®¾å¤‡å‘½ä»¤
   */
  async sendDeviceCommand(deviceId, command, params = {}) {
    if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
      throw new Error('WebSocketè¿æ¥æœªå»ºç«‹');
    }
    
    const message = {
      type: 'device_command',
      data: {
        deviceId,
        command,
        params,
        timestamp: Date.now()
      }
    };
    
    this.websocket.send(JSON.stringify(message));
  }

  /**
   * è®¡åˆ’é‡è¿
   */
  scheduleReconnect() {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
      return;
    }
    
    this.reconnectAttempts++;
    console.log(`${this.reconnectInterval / 1000}ç§’åå°è¯•ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿`);
    
    setTimeout(() => {
      this.initialize();
    }, this.reconnectInterval);
  }

  /**
   * è·å–è¿æ¥çŠ¶æ€
   */
  getConnectionStatus() {
    return {
      isConnected: this.isConnected,
      websocketState: this.websocket?.readyState,
      reconnectAttempts: this.reconnectAttempts
    };
  }

  /**
   * æ–­å¼€è¿æ¥
   */
  disconnect() {
    this.isConnected = false;
    
    if (this.websocket) {
      this.websocket.close();
      this.websocket = null;
    }
    
    if (this.mqttClient) {
      // æ–­å¼€MQTTè¿æ¥
      this.mqttClient = null;
    }
    
    console.log('IoTæ•°æ®æœåŠ¡å·²æ–­å¼€è¿æ¥');
  }

  /**
   * æ¸…ç†èµ„æº
   */
  destroy() {
    this.disconnect();
    this.deviceData.clear();
    this.listeners.clear();
  }
}

export default IoTDataService;

          
åˆ›å»ºä¸»è¦çš„åœ°å›¾é¡µé¢ç»„ä»¶ï¼Œé›†æˆé«˜å¾·åœ°å›¾å’ŒIoTæ•°æ®æœåŠ¡ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/pages/MapPage.jsx
          
content: import React, { useState, useEffect, useRef, useCallback } from 'react';
import AmapComponent from '../components/AmapComponent';
import configService from '../services/ConfigService';
import IoTDataService from '../services/IoTDataService';

/**
 * åœ°å›¾ä¸»é¡µé¢ç»„ä»¶
 * é›†æˆé«˜å¾·åœ°å›¾æ˜¾ç¤ºå’ŒIoTè®¾å¤‡æ•°æ®å¯è§†åŒ–
 */
const MapPage = () => {
  const [config, setConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [devices, setDevices] = useState([]);
  const [selectedDevice, setSelectedDevice] = useState(null);
  const [connectionStatus, setConnectionStatus] = useState({ isConnected: false });
  const [showDevicePanel, setShowDevicePanel] = useState(true);
  const [timeRange, setTimeRange] = useState('1h'); // 1h, 6h, 24h, 7d
  
  const amapRef = useRef(null);
  const iotServiceRef = useRef(null);

  // åˆå§‹åŒ–é…ç½®å’ŒæœåŠ¡
  useEffect(() => {
    const initialize = async () => {
      try {
        setLoading(true);
        setError(null);

        // åŠ è½½é…ç½®
        const loadedConfig = await configService.loadConfig();
        setConfig(loadedConfig);

        // éªŒè¯é…ç½®
        const validation = configService.validateConfig();
        if (!validation.valid) {
          console.warn('é…ç½®éªŒè¯å¤±è´¥:', validation.errors);
        }

        // åˆå§‹åŒ–IoTæ•°æ®æœåŠ¡
        iotServiceRef.current = new IoTDataService(loadedConfig);
        await iotServiceRef.current.initialize();

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        iotServiceRef.current.addEventListener('device_location_update', handleDeviceLocationUpdate);
        iotServiceRef.current.addEventListener('device_status_update', handleDeviceStatusUpdate);
        iotServiceRef.current.addEventListener('historical_data_loaded', handleHistoricalDataLoaded);
        iotServiceRef.current.addEventListener('system_alert', handleSystemAlert);

        // æ›´æ–°è¿æ¥çŠ¶æ€
        setConnectionStatus(iotServiceRef.current.getConnectionStatus());
        
        setLoading(false);
      } catch (err) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', err);
        setError(err.message);
        setLoading(false);
      }
    };

    initialize();

    // æ¸…ç†å‡½æ•°
    return () => {
      if (iotServiceRef.current) {
        iotServiceRef.current.destroy();
      }
    };
  }, []);

  // å®šæœŸæ›´æ–°è¿æ¥çŠ¶æ€
  useEffect(() => {
    const interval = setInterval(() => {
      if (iotServiceRef.current) {
        setConnectionStatus(iotServiceRef.current.getConnectionStatus());
      }
    }, 5000);

    return () => clearInterval(interval);
  }, []);

  // å¤„ç†è®¾å¤‡ä½ç½®æ›´æ–°
  const handleDeviceLocationUpdate = useCallback((data) => {
    const { deviceId, location, timestamp, device } = data;
    
    setDevices(prevDevices => {
      const existingIndex = prevDevices.findIndex(d => d.id === deviceId);
      if (existingIndex >= 0) {
        const updatedDevices = [...prevDevices];
        updatedDevices[existingIndex] = device;
        return updatedDevices;
      } else {
        return [...prevDevices, device];
      }
    });

    // å¦‚æœåœ°å›¾å·²å‡†å¤‡å°±ç»ªï¼Œæ›´æ–°åœ°å›¾ä¸Šçš„æ ‡è®°
    if (amapRef.current) {
      updateDeviceMarker(deviceId, location, device.status);
    }
  }, []);

  // å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°
  const handleDeviceStatusUpdate = useCallback((data) => {
    const { deviceId, status, device } = data;
    
    setDevices(prevDevices => 
      prevDevices.map(d => 
        d.id === deviceId ? { ...d, status } : d
      )
    );
  }, []);

  // å¤„ç†å†å²æ•°æ®åŠ è½½
  const handleHistoricalDataLoaded = useCallback((data) => {
    const { deviceId, locations, device } = data;
    
    if (amapRef.current && selectedDevice === deviceId) {
      // ç»˜åˆ¶å†å²è½¨è¿¹
      const coordinates = locations.map(loc => ({
        lng: loc.lng,
        lat: loc.lat,
        timestamp: loc.timestamp
      }));
      
      amapRef.current.drawPath(coordinates, {
        id: `history_${deviceId}`,
        color: '#FF6B6B',
        weight: 4,
        opacity: 0.7
      });
    }
  }, [selectedDevice]);

  // å¤„ç†ç³»ç»Ÿå‘Šè­¦
  const handleSystemAlert = useCallback((data) => {
    console.log('æ”¶åˆ°ç³»ç»Ÿå‘Šè­¦:', data);
    // è¿™é‡Œå¯ä»¥æ·»åŠ å‘Šè­¦é€šçŸ¥UI
  }, []);

  // æ›´æ–°è®¾å¤‡æ ‡è®°
  const updateDeviceMarker = (deviceId, location, status) => {
    if (!amapRef.current) return;

    const iconColor = getStatusColor(status);
    const markerOptions = {
      id: `device_${deviceId}`,
      title: `è®¾å¤‡ ${deviceId}`,
      icon: createDeviceIcon(iconColor),
      infoWindow: `
        <div style="padding: 10px; min-width: 200px;">
          <h4 style="margin: 0 0 8px 0;">è®¾å¤‡ ${deviceId}</h4>
          <p style="margin: 4px 0;">çŠ¶æ€: <span style="color: ${iconColor}">${getStatusText(status)}</span></p>
          <p style="margin: 4px 0;">ä½ç½®: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</p>
          <p style="margin: 4px 0;">æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}</p>
        </div>
      `
    };

    amapRef.current.addMarker(location, markerOptions);
  };

  // è·å–çŠ¶æ€é¢œè‰²
  const getStatusColor = (status) => {
    switch (status) {
      case 'online': return '#52c41a';
      case 'offline': return '#ff4d4f';
      case 'warning': return '#faad14';
      default: return '#d9d9d9';
    }
  };

  // è·å–çŠ¶æ€æ–‡æœ¬
  const getStatusText = (status) => {
    switch (status) {
      case 'online': return 'åœ¨çº¿';
      case 'offline': return 'ç¦»çº¿';
      case 'warning': return 'å‘Šè­¦';
      default: return 'æœªçŸ¥';
    }
  };

  // åˆ›å»ºè®¾å¤‡å›¾æ ‡
  const createDeviceIcon = (color) => {
    return `data:image/svg+xml;base64,${btoa(`
      <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="8" fill="${color}" stroke="white" stroke-width="2"/>
        <circle cx="12" cy="12" r="3" fill="white"/>
      </svg>
    `)}`;
  };

  // å¤„ç†åœ°å›¾å‡†å¤‡å°±ç»ª
  const handleMapReady = useCallback((amapService) => {
    amapRef.current = amapService;
    
    // åŠ è½½ç°æœ‰è®¾å¤‡æ•°æ®
    if (iotServiceRef.current) {
      const allDevices = iotServiceRef.current.getAllDeviceData();
      setDevices(allDevices);
      
      // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡
      allDevices.forEach(device => {
        if (device.locations.length > 0) {
          const lastLocation = device.locations[device.locations.length - 1];
          updateDeviceMarker(device.id, lastLocation, device.status);
        }
      });
    }
  }, []);

  // å¤„ç†è®¾å¤‡é€‰æ‹©
  const handleDeviceSelect = (deviceId) => {
    setSelectedDevice(deviceId);
    
    if (iotServiceRef.current && amapRef.current) {
      // æ¸…é™¤ä¹‹å‰çš„è½¨è¿¹
      amapRef.current.clearAll();
      
      // é‡æ–°æ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡æ ‡è®°
      devices.forEach(device => {
        if (device.locations.length > 0) {
          const lastLocation = device.locations[device.locations.length - 1];
          updateDeviceMarker(device.id, lastLocation, device.status);
        }
      });
      
      // è¯·æ±‚é€‰ä¸­è®¾å¤‡çš„å†å²æ•°æ®
      const endTime = Date.now();
      const startTime = endTime - getTimeRangeMs(timeRange);
      iotServiceRef.current.requestHistoricalData(deviceId, startTime, endTime);
    }
  };

  // è·å–æ—¶é—´èŒƒå›´æ¯«ç§’æ•°
  const getTimeRangeMs = (range) => {
    switch (range) {
      case '1h': return 60 * 60 * 1000;
      case '6h': return 6 * 60 * 60 * 1000;
      case '24h': return 24 * 60 * 60 * 1000;
      case '7d': return 7 * 24 * 60 * 60 * 1000;
      default: return 60 * 60 * 1000;
    }
  };

  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        flexDirection: 'column'
      }}>
        <div style={{ fontSize: '18px', marginBottom: '16px' }}>ğŸš€ æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
        <div style={{ fontSize: '14px', color: '#666' }}>åŠ è½½é…ç½®å’Œè¿æ¥æœåŠ¡ä¸­</div>
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        flexDirection: 'column',
        color: '#ff4d4f'
      }}>
        <div style={{ fontSize: '18px', marginBottom: '16px' }}>âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</div>
        <div style={{ fontSize: '14px' }}>{error}</div>
      </div>
    );
  }

  return (
    <div style={{ display: 'flex', height: '100vh', fontFamily: 'Arial, sans-serif' }}>
      {/* è®¾å¤‡é¢æ¿ */}
      {showDevicePanel && (
        <div style={{
          width: '300px',
          backgroundColor: '#f5f5f5',
          borderRight: '1px solid #d9d9d9',
          display: 'flex',
          flexDirection: 'column'
        }}>
          {/* é¢æ¿å¤´éƒ¨ */}
          <div style={{
            padding: '16px',
            borderBottom: '1px solid #d9d9d9',
            backgroundColor: 'white'
          }}>
            <h3 style={{ margin: '0 0 8px 0' }}>è®¾å¤‡ç›‘æ§</h3>
            <div style={{ 
              fontSize: '12px', 
              color: connectionStatus.isConnected ? '#52c41a' : '#ff4d4f'
            }}>
              â— {connectionStatus.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
            </div>
          </div>

          {/* æ—¶é—´èŒƒå›´é€‰æ‹© */}
          <div style={{ padding: '12px 16px', borderBottom: '1px solid #e8e8e8' }}>
            <div style={{ fontSize: '12px', marginBottom: '8px', color: '#666' }}>æ—¶é—´èŒƒå›´:</div>
            <select 
              value={timeRange} 
              onChange={(e) => setTimeRange(e.target.value)}
              style={{ width: '100%', padding: '4px 8px' }}
            >
              <option value="1h">æœ€è¿‘1å°æ—¶</option>
              <option value="6h">æœ€è¿‘6å°æ—¶</option>
              <option value="24h">æœ€è¿‘24å°æ—¶</option>
              <option value="7d">æœ€è¿‘7å¤©</option>
            </select>
          </div>

          {/* è®¾å¤‡åˆ—è¡¨ */}
          <div style={{ flex: 1, overflow: 'auto' }}>
            {devices.length === 0 ? (
              <div style={{ 
                padding: '20px', 
                textAlign: 'center', 
                color: '#666',
                fontSize: '14px'
              }}>
                æš‚æ— è®¾å¤‡æ•°æ®
              </div>
            ) : (
              devices.map(device => (
                <div
                  key={device.id}
                  onClick={() => handleDeviceSelect(device.id)}
                  style={{
                    padding: '12px 16px',
                    borderBottom: '1px solid #e8e8e8',
                    cursor: 'pointer',
                    backgroundColor: selectedDevice === device.id ? '#e6f7ff' : 'white',
                    ':hover': { backgroundColor: '#f0f0f0' }
                  }}
                >
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '4px'
                  }}>
                    <span style={{ fontWeight: 'bold' }}>è®¾å¤‡ {device.id}</span>
                    <span style={{ 
                      fontSize: '12px',
                      color: getStatusColor(device.status),
                      fontWeight: 'bold'
                    }}>
                      {getStatusText(device.status)}
                    </span>
                  </div>
                  <div style={{ fontSize: '12px', color: '#666' }}>
                    ä½ç½®ç‚¹: {device.locations.length}
                  </div>
                  {device.lastUpdate && (
                    <div style={{ fontSize: '12px', color: '#666' }}>
                      æ›´æ–°: {new Date(device.lastUpdate).toLocaleTimeString()}
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* åœ°å›¾åŒºåŸŸ */}
      <div style={{ flex: 1, position: 'relative' }}>
        {/* å·¥å…·æ  */}
        <div style={{
          position: 'absolute',
          top: '16px',
          right: '16px',
          zIndex: 1000,
          display: 'flex',
          gap: '8px'
        }}>
          <button
            onClick={() => setShowDevicePanel(!showDevicePanel)}
            style={{
              padding: '8px 12px',
              backgroundColor: 'white',
              border: '1px solid #d9d9d9',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '12px'
            }}
          >
            {showDevicePanel ? 'éšè—é¢æ¿' : 'æ˜¾ç¤ºé¢æ¿'}
          </button>
          <button
            onClick={() => amapRef.current?.clearAll()}
            style={{
              padding: '8px 12px',
              backgroundColor: 'white',
              border: '1px solid #d9d9d9',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '12px'
            }}
          >
            æ¸…é™¤è½¨è¿¹
          </button>
        </div>

        {/* é«˜å¾·åœ°å›¾ç»„ä»¶ */}
        {config && (
          <AmapComponent
            config={config.amap}
            onMapReady={handleMapReady}
            style={{ width: '100%', height: '100%' }}
          />
        )}
      </div>
    </div>
  );
};

export default MapPage;

          
åˆ›å»ºå‰ç«¯åº”ç”¨çš„å…¥å£æ–‡ä»¶App.jsxï¼Œé›†æˆè·¯ç”±å’Œä¸»è¦ç»„ä»¶ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/App.jsx
          
content: import React from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import MapPage from './pages/MapPage';
import './App.css';

/**
 * ä¸»åº”ç”¨ç»„ä»¶
 * é…ç½®è·¯ç”±å’Œå…¨å±€å¸ƒå±€
 */
function App() {
  return (
    <Router>
      <div className="App">
        <Routes>
          {/* é»˜è®¤è·¯ç”±é‡å®šå‘åˆ°åœ°å›¾é¡µé¢ */}
          <Route path="/" element={<Navigate to="/map" replace />} />
          
          {/* åœ°å›¾é¡µé¢è·¯ç”± */}
          <Route path="/map" element={<MapPage />} />
          
          {/* 404é¡µé¢ */}
          <Route path="*" element={<NotFoundPage />} />
        </Routes>
      </div>
    </Router>
  );
}

/**
 * 404é¡µé¢ç»„ä»¶
 */
const NotFoundPage = () => {
  return (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      height: '100vh',
      fontFamily: 'Arial, sans-serif'
    }}>
      <h1 style={{ fontSize: '48px', margin: '0', color: '#ff4d4f' }}>404</h1>
      <p style={{ fontSize: '18px', margin: '16px 0', color: '#666' }}>é¡µé¢æœªæ‰¾åˆ°</p>
      <a 
        href="/map" 
        style={{
          padding: '12px 24px',
          backgroundColor: '#1890ff',
          color: 'white',
          textDecoration: 'none',
          borderRadius: '4px',
          fontSize: '14px'
        }}
      >
        è¿”å›åœ°å›¾é¡µé¢
      </a>
    </div>
  );
};

export default App;

          
åˆ›å»ºå‰ç«¯åº”ç”¨çš„CSSæ ·å¼æ–‡ä»¶ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/App.css
          
content: /* å…¨å±€æ ·å¼é‡ç½® */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: #f0f2f5;
}

#root {
  height: 100%;
}

.App {
  height: 100%;
}

/* åœ°å›¾å®¹å™¨æ ·å¼ */
.amap-container {
  position: relative;
  width: 100%;
  height: 100%;
}

.amap-error {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #fff2f0;
  border: 1px solid #ffccc7;
  border-radius: 6px;
}

/* è®¾å¤‡é¢æ¿æ ·å¼ */
.device-panel {
  background-color: #ffffff;
  border-right: 1px solid #e8e8e8;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.device-item {
  transition: background-color 0.2s ease;
  border-left: 3px solid transparent;
}

.device-item:hover {
  background-color: #f5f5f5 !important;
}

.device-item.selected {
  background-color: #e6f7ff;
  border-left-color: #1890ff;
}

.device-item.online {
  border-left-color: #52c41a;
}

.device-item.offline {
  border-left-color: #ff4d4f;
}

.device-item.warning {
  border-left-color: #faad14;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}

.status-indicator.online {
  background-color: #52c41a;
  box-shadow: 0 0 0 2px rgba(82, 196, 26, 0.2);
}

.status-indicator.offline {
  background-color: #ff4d4f;
  box-shadow: 0 0 0 2px rgba(255, 77, 79, 0.2);
}

.status-indicator.warning {
  background-color: #faad14;
  box-shadow: 0 0 0 2px rgba(250, 173, 20, 0.2);
}

/* å·¥å…·æ æ ·å¼ */
.toolbar {
  background-color: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(8px);
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.toolbar button {
  transition: all 0.2s ease;
  font-weight: 500;
}

.toolbar button:hover {
  background-color: #f0f0f0;
  border-color: #40a9ff;
  color: #40a9ff;
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #1890ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .device-panel {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 1001;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }
  
  .device-panel.show {
    transform: translateX(0);
  }
  
  .toolbar {
    position: fixed;
    top: 16px;
    left: 16px;
    right: 16px;
    z-index: 1000;
  }
}

/* ä¿¡æ¯çª—å£æ ·å¼ */
.amap-info-window {
  font-family: inherit;
}

.amap-info-window h4 {
  color: #262626;
  font-size: 14px;
  font-weight: 600;
}

.amap-info-window p {
  color: #595959;
  font-size: 12px;
  line-height: 1.4;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* é€‰æ‹©æ¡†æ ·å¼ */
select {
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  font-size: 12px;
  outline: none;
  transition: border-color 0.2s ease;
}

select:focus {
  border-color: #40a9ff;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

/* æŒ‰é’®æ ·å¼ */
button {
  outline: none;
  transition: all 0.2s ease;
}

button:active {
  transform: translateY(1px);
}

/* å¡ç‰‡æ ·å¼ */
.card {
  background: white;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e8e8e8;
}

/* æ–‡æœ¬æ ·å¼ */
.text-primary {
  color: #1890ff;
}

.text-success {
  color: #52c41a;
}

.text-warning {
  color: #faad14;
}

.text-danger {
  color: #ff4d4f;
}

.text-muted {
  color: #8c8c8c;
}

/* å·¥å…·æç¤ºæ ·å¼ */
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: center;
  border-radius: 4px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.slide-in-left {
  animation: slideInLeft 0.3s ease-out;
}

@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

          
åˆ›å»ºå‰ç«¯åº”ç”¨çš„å…¥å£æ–‡ä»¶index.jsï¼Œç”¨äºå¯åŠ¨Reactåº”ç”¨ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/index.js
          
content: import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

// åˆ›å»ºReactåº”ç”¨æ ¹èŠ‚ç‚¹
const root = ReactDOM.createRoot(document.getElementById('root'));

// æ¸²æŸ“åº”ç”¨
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

// æ€§èƒ½ç›‘æ§ï¼ˆå¯é€‰ï¼‰
if (process.env.NODE_ENV === 'development') {
  // å¼€å‘ç¯å¢ƒä¸‹çš„æ€§èƒ½ç›‘æ§
  const reportWebVitals = (onPerfEntry) => {
    if (onPerfEntry && onPerfEntry instanceof Function) {
      import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
        getCLS(onPerfEntry);
        getFID(onPerfEntry);
        getFCP(onPerfEntry);
        getLCP(onPerfEntry);
        getTTFB(onPerfEntry);
      });
    }
  };
  
  reportWebVitals(console.log);
}

          
åˆ›å»ºå‰ç«¯åº”ç”¨çš„åŸºç¡€CSSæ ·å¼æ–‡ä»¶index.cssã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/index.css
          
content: /* åŸºç¡€æ ·å¼é‡ç½®å’Œå…¨å±€æ ·å¼ */

/* CSSé‡ç½® */
*, *::before, *::after {
  box-sizing: border-box;
}

html {
  line-height: 1.15;
  -webkit-text-size-adjust: 100%;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: #f0f2f5;
  color: #262626;
  font-size: 14px;
  line-height: 1.5715;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}

/* é“¾æ¥æ ·å¼ */
a {
  color: #1890ff;
  text-decoration: none;
  background-color: transparent;
  outline: none;
  cursor: pointer;
  transition: color 0.3s;
}

a:hover {
  color: #40a9ff;
}

a:active {
  color: #096dd9;
}

/* æ ‡é¢˜æ ·å¼ */
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 0.5em;
  color: rgba(0, 0, 0, 0.85);
  font-weight: 500;
}

h1 {
  font-size: 38px;
  line-height: 1.23;
}

h2 {
  font-size: 30px;
  line-height: 1.35;
}

h3 {
  font-size: 24px;
  line-height: 1.35;
}

h4 {
  font-size: 20px;
  line-height: 1.4;
}

h5 {
  font-size: 16px;
  line-height: 1.5;
}

h6 {
  font-size: 14px;
  line-height: 1.5;
}

/* æ®µè½æ ·å¼ */
p {
  margin-top: 0;
  margin-bottom: 1em;
}

/* åˆ—è¡¨æ ·å¼ */
ul, ol {
  margin-top: 0;
  margin-bottom: 1em;
  padding-left: 2em;
}

li {
  margin-bottom: 0.25em;
}

/* è¡¨å•å…ƒç´ æ ·å¼ */
input, button, select, textarea {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"],
select,
textarea {
  display: block;
  width: 100%;
  padding: 4px 11px;
  color: rgba(0, 0, 0, 0.85);
  font-size: 14px;
  line-height: 1.5715;
  background-color: #fff;
  background-image: none;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  transition: all 0.3s;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #40a9ff;
  outline: 0;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

/* æŒ‰é’®æ ·å¼ */
button {
  display: inline-block;
  font-weight: 400;
  white-space: nowrap;
  text-align: center;
  background-image: none;
  border: 1px solid transparent;
  cursor: pointer;
  padding: 4px 15px;
  font-size: 14px;
  border-radius: 6px;
  transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
  user-select: none;
  touch-action: manipulation;
  line-height: 1.5715;
  position: relative;
  color: rgba(0, 0, 0, 0.85);
  background: #fff;
  border-color: #d9d9d9;
}

button:hover {
  color: #40a9ff;
  background: #fff;
  border-color: #40a9ff;
}

button:focus {
  outline: 0;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

button:active {
  color: #096dd9;
  background: #fff;
  border-color: #096dd9;
}

button:disabled {
  color: rgba(0, 0, 0, 0.25);
  background: #f5f5f5;
  border-color: #d9d9d9;
  cursor: not-allowed;
}

/* ä¸»è¦æŒ‰é’®æ ·å¼ */
button.primary {
  color: #fff;
  background: #1890ff;
  border-color: #1890ff;
}

button.primary:hover {
  color: #fff;
  background: #40a9ff;
  border-color: #40a9ff;
}

button.primary:active {
  color: #fff;
  background: #096dd9;
  border-color: #096dd9;
}

/* å±é™©æŒ‰é’®æ ·å¼ */
button.danger {
  color: #fff;
  background: #ff4d4f;
  border-color: #ff4d4f;
}

button.danger:hover {
  color: #fff;
  background: #ff7875;
  border-color: #ff7875;
}

button.danger:active {
  color: #fff;
  background: #d9363e;
  border-color: #d9363e;
}

/* è¡¨æ ¼æ ·å¼ */
table {
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
}

th, td {
  padding: 16px;
  text-align: left;
  border-bottom: 1px solid #f0f0f0;
}

th {
  color: rgba(0, 0, 0, 0.85);
  font-weight: 500;
  background: #fafafa;
}

/* å·¥å…·ç±» */
.text-center {
  text-align: center;
}

.text-left {
  text-align: left;
}

.text-right {
  text-align: right;
}

.d-flex {
  display: flex;
}

.d-block {
  display: block;
}

.d-inline {
  display: inline;
}

.d-inline-block {
  display: inline-block;
}

.d-none {
  display: none;
}

.justify-content-center {
  justify-content: center;
}

.justify-content-between {
  justify-content: space-between;
}

.align-items-center {
  align-items: center;
}

.flex-column {
  flex-direction: column;
}

.flex-1 {
  flex: 1;
}

.w-100 {
  width: 100%;
}

.h-100 {
  height: 100%;
}

.m-0 {
  margin: 0;
}

.p-0 {
  padding: 0;
}

.mt-1 {
  margin-top: 8px;
}

.mb-1 {
  margin-bottom: 8px;
}

.ml-1 {
  margin-left: 8px;
}

.mr-1 {
  margin-right: 8px;
}

.pt-1 {
  padding-top: 8px;
}

.pb-1 {
  padding-bottom: 8px;
}

.pl-1 {
  padding-left: 8px;
}

.pr-1 {
  padding-right: 8px;
}

/* å“åº”å¼å·¥å…·ç±» */
@media (max-width: 576px) {
  .d-sm-none {
    display: none;
  }
  
  .d-sm-block {
    display: block;
  }
}

@media (max-width: 768px) {
  .d-md-none {
    display: none;
  }
  
  .d-md-block {
    display: block;
  }
}

@media (max-width: 992px) {
  .d-lg-none {
    display: none;
  }
  
  .d-lg-block {
    display: block;
  }
}

/* æ‰“å°æ ·å¼ */
@media print {
  * {
    color: #000 !important;
    background: transparent !important;
    box-shadow: none !important;
    text-shadow: none !important;
  }
  
  a, a:visited {
    text-decoration: underline;
  }
  
  img {
    max-width: 100% !important;
  }
  
  p, h2, h3 {
    orphans: 3;
    widows: 3;
  }
  
  h2, h3 {
    page-break-after: avoid;
  }
}

          
åˆ›å»ºå‰ç«¯åº”ç”¨çš„HTMLæ¨¡æ¿æ–‡ä»¶public/index.htmlã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/frontend/public/index.html
          
content: <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="åŸºäºä½ç½®æœåŠ¡çš„ç‰©è”ç½‘ç³»ç»Ÿ - é«˜å¾·åœ°å›¾é›†æˆ" />
  <meta name="keywords" content="LBS, IoT, é«˜å¾·åœ°å›¾, ä½ç½®æœåŠ¡, ç‰©è”ç½‘, å®æ—¶å®šä½" />
  <meta name="author" content="LBS IoT Team" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://lbsiot.example.com/" />
  <meta property="og:title" content="LBS IoT - åŸºäºä½ç½®æœåŠ¡çš„ç‰©è”ç½‘ç³»ç»Ÿ" />
  <meta property="og:description" content="å®æ—¶è®¾å¤‡å®šä½è¿½è¸ªå’Œæ•°æ®å¯è§†åŒ–å¹³å°" />
  <meta property="og:image" content="%PUBLIC_URL%/og-image.png" />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://lbsiot.example.com/" />
  <meta property="twitter:title" content="LBS IoT - åŸºäºä½ç½®æœåŠ¡çš„ç‰©è”ç½‘ç³»ç»Ÿ" />
  <meta property="twitter:description" content="å®æ—¶è®¾å¤‡å®šä½è¿½è¸ªå’Œæ•°æ®å¯è§†åŒ–å¹³å°" />
  <meta property="twitter:image" content="%PUBLIC_URL%/twitter-image.png" />
  
  <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
  <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
  
  <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
  <link rel="preconnect" href="https://webapi.amap.com" />
  <link rel="dns-prefetch" href="https://webapi.amap.com" />
  
  <!-- é«˜å¾·åœ°å›¾APIé¢„åŠ è½½ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦æ›´å¿«çš„åŠ è½½é€Ÿåº¦ï¼‰ -->
  <!-- <link rel="preload" href="https://webapi.amap.com/maps?v=2.0&key=YOUR_API_KEY" as="script" /> -->
  
  <title>LBS IoT - åŸºäºä½ç½®æœåŠ¡çš„ç‰©è”ç½‘ç³»ç»Ÿ</title>
  
  <style>
    /* åŠ è½½åŠ¨ç”»æ ·å¼ */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1890ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .loading-subtext {
      color: #999;
      font-size: 12px;
    }
    
    /* éšè—åŠ è½½åŠ¨ç”»çš„ç±» */
    .loading-hidden {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>
</head>
<body>
  <noscript>
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    ">
      <h1 style="color: #ff4d4f; margin-bottom: 16px;">âš ï¸ JavaScript å·²ç¦ç”¨</h1>
      <p style="color: #666; margin-bottom: 16px;">æ­¤åº”ç”¨éœ€è¦å¯ç”¨ JavaScript æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚</p>
      <p style="color: #999; font-size: 14px;">è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¯ç”¨ JavaScriptï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚</p>
    </div>
  </noscript>
  
  <!-- åˆå§‹åŠ è½½åŠ¨ç”» -->
  <div id="initial-loading" class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨åŠ è½½ LBS IoT ç³»ç»Ÿ</div>
    <div class="loading-subtext">åˆå§‹åŒ–åœ°å›¾æœåŠ¡å’Œæ•°æ®è¿æ¥...</div>
  </div>
  
  <!-- React åº”ç”¨æŒ‚è½½ç‚¹ -->
  <div id="root"></div>
  
  <script>
    // éšè—åˆå§‹åŠ è½½åŠ¨ç”»
    window.addEventListener('load', function() {
      setTimeout(function() {
        const loadingElement = document.getElementById('initial-loading');
        if (loadingElement) {
          loadingElement.classList.add('loading-hidden');
          setTimeout(function() {
            loadingElement.style.display = 'none';
          }, 300);
        }
      }, 1000); // è‡³å°‘æ˜¾ç¤º1ç§’åŠ è½½åŠ¨ç”»
    });
    
    // é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('å…¨å±€é”™è¯¯:', e.error);
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
    });
    
    // æœªå¤„ç†çš„Promiseæ‹’ç»
    window.addEventListener('unhandledrejection', function(e) {
      console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
    });
    
    // æ€§èƒ½ç›‘æ§
    if ('performance' in window) {
      window.addEventListener('load', function() {
        setTimeout(function() {
          const perfData = performance.getEntriesByType('navigation')[0];
          if (perfData) {
            console.log('é¡µé¢åŠ è½½æ€§èƒ½:', {
              domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
              loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
              totalTime: perfData.loadEventEnd - perfData.fetchStart
            });
          }
        }, 0);
      });
    }
  </script>
</body>
</html>

          
æ›´æ–°package.jsonæ–‡ä»¶ï¼Œæ·»åŠ Reactå’Œé«˜å¾·åœ°å›¾ç›¸å…³çš„ä¾èµ–åŒ…ã€‚
        
            
toolName: edit_file_update
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/package.json
          
changes: 
              
newStr:   "dependencies": {
    "express": "^4.18.2",
    "socket.io": "^4.7.2",
    "amqplib": "^0.10.3",
    "mongoose": "^7.5.0",
    "redis": "^4.6.8",
    "dotenv": "^16.3.1",
    "cors": "^2.8.5",
    "helmet": "^7.0.0",
    "compression": "^1.7.4",
    "multer": "^1.4.5-lts.1",
    "joi": "^17.9.2",
    "winston": "^3.10.0",
    "moment": "^2.29.4",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.15.0",
    "mqtt": "^5.0.5"
  },
              
oldStr:   "dependencies": {
    "express": "^4.18.2",
    "socket.io": "^4.7.2",
    "google-maps": "^1.0.0",
    "amqplib": "^0.10.3",
    "mongoose": "^7.5.0",
    "redis": "^4.6.8",
    "dotenv": "^16.3.1",
    "cors": "^2.8.5",
    "helmet": "^7.0.0",
    "compression": "^1.7.4",
    "multer": "^1.4.5-lts.1",
    "joi": "^17.9.2",
    "winston": "^3.10.0",
    "moment": "^2.29.4"
  },
            
          
æ›´æ–°package.jsonçš„devDependenciesï¼Œæ·»åŠ Reactå¼€å‘ç›¸å…³çš„å·¥å…·å’Œä¾èµ–ã€‚
        
            
toolName: edit_file_update
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/package.json
          
changes: 
              
newStr:   "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.6.2",
    "supertest": "^6.3.3",
    "eslint": "^8.47.0",
    "prettier": "^3.0.2",
    "webpack": "^5.88.2",
    "webpack-cli": "^5.1.4",
    "jsdoc": "^4.0.2",
    "@babel/core": "^7.22.0",
    "@babel/preset-env": "^7.22.0",
    "@babel/preset-react": "^7.22.0",
    "babel-loader": "^9.1.0",
    "css-loader": "^6.8.0",
    "style-loader": "^3.3.0",
    "html-webpack-plugin": "^5.5.0",
    "webpack-dev-server": "^4.15.0",
    "@testing-library/react": "^13.4.0",
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/user-event": "^14.4.0",
    "web-vitals": "^3.4.0"
  },
              
oldStr:   "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.6.2",
    "supertest": "^6.3.3",
    "eslint": "^8.47.0",
    "prettier": "^3.0.2",
    "webpack": "^5.88.2",
    "webpack-cli": "^5.1.4",
    "jsdoc": "^4.0.2"
  },
            
          
æ›´æ–°package.jsonçš„scriptséƒ¨åˆ†ï¼Œæ·»åŠ å‰ç«¯å¼€å‘å’Œæ„å»ºç›¸å…³çš„è„šæœ¬å‘½ä»¤ã€‚
        
            
toolName: edit_file_update
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/package.json
          
changes: 
              
newStr:   "scripts": {
    "start": "node src/backend/index.js",
    "dev": "nodemon src/backend/index.js",
    "dev:frontend": "webpack serve --mode development --config webpack.config.js",
    "dev:backend": "nodemon src/backend/index.js",
    "dev:all": "concurrently \"npm run dev:backend\" \"npm run dev:frontend\"",
    "test": "jest",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:e2e": "jest tests/e2e",
    "test:frontend": "jest --testPathPattern=src/frontend",
    "build": "webpack --mode production",
    "build:dev": "webpack --mode development",
    "build:frontend": "webpack --mode production --config webpack.config.js",
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix",
    "docs:generate": "jsdoc src/ -d docs/api",
    "deploy": "scripts/deployment/deploy.sh",
    "install:all": "npm install",
    "clean": "rm -rf dist/ build/ node_modules/.cache"
  },
              
oldStr:   "scripts": {
    "start": "node src/backend/index.js",
    "dev": "nodemon src/backend/index.js",
    "test": "jest",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:e2e": "jest tests/e2e",
    "build": "webpack --mode production",
    "build:dev": "webpack --mode development",
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix",
    "docs:generate": "jsdoc src/ -d docs/api",
    "deploy": "scripts/deployment/deploy.sh"
  },
            
          
æ·»åŠ concurrentlyä¾èµ–åˆ°devDependenciesï¼Œç”¨äºåŒæ—¶è¿è¡Œå‰ç«¯å’Œåç«¯å¼€å‘æœåŠ¡å™¨ã€‚
        
            
toolName: edit_file_update
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/package.json
          
changes: 
              
newStr:     "@testing-library/react": "^13.4.0",
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/user-event": "^14.4.0",
    "web-vitals": "^3.4.0",
    "concurrently": "^8.2.0"
              
oldStr:     "@testing-library/react": "^13.4.0",
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/user-event": "^14.4.0",
    "web-vitals": "^3.4.0"
            
          
åˆ›å»ºWebpacké…ç½®æ–‡ä»¶ï¼Œç”¨äºæ„å»ºå’Œå¼€å‘å‰ç«¯åº”ç”¨ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/webpack.config.js
          
content: const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';
  
  return {
    entry: './src/frontend/index.js',
    
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: isProduction ? '[name].[contenthash].js' : '[name].js',
      chunkFilename: isProduction ? '[name].[contenthash].chunk.js' : '[name].chunk.js',
      publicPath: '/',
      clean: true
    },
    
    resolve: {
      extensions: ['.js', '.jsx', '.json'],
      alias: {
        '@': path.resolve(__dirname, 'src/frontend'),
        '@components': path.resolve(__dirname, 'src/frontend/components'),
        '@services': path.resolve(__dirname, 'src/frontend/services'),
        '@pages': path.resolve(__dirname, 'src/frontend/pages'),
        '@utils': path.resolve(__dirname, 'src/frontend/utils'),
        '@assets': path.resolve(__dirname, 'src/frontend/assets')
      }
    },
    
    module: {
      rules: [
        {
          test: /\.(js|jsx)$/,
          exclude: /node_modules/,
          use: {
            loader: 'babel-loader',
            options: {
              presets: [
                ['@babel/preset-env', {
                  targets: {
                    browsers: ['> 1%', 'last 2 versions', 'not ie <= 8']
                  },
                  useBuiltIns: 'usage',
                  corejs: 3
                }],
                ['@babel/preset-react', {
                  runtime: 'automatic'
                }]
              ],
              plugins: [
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–Babelæ’ä»¶
              ]
            }
          }
        },
        {
          test: /\.css$/,
          use: [
            'style-loader',
            {
              loader: 'css-loader',
              options: {
                importLoaders: 1,
                sourceMap: !isProduction
              }
            }
          ]
        },
        {
          test: /\.(png|jpe?g|gif|svg|ico)$/i,
          type: 'asset/resource',
          generator: {
            filename: 'images/[name].[hash][ext]'
          }
        },
        {
          test: /\.(woff|woff2|eot|ttf|otf)$/i,
          type: 'asset/resource',
          generator: {
            filename: 'fonts/[name].[hash][ext]'
          }
        }
      ]
    },
    
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/frontend/public/index.html',
        filename: 'index.html',
        inject: true,
        minify: isProduction ? {
          removeComments: true,
          collapseWhitespace: true,
          removeRedundantAttributes: true,
          useShortDoctype: true,
          removeEmptyAttributes: true,
          removeStyleLinkTypeAttributes: true,
          keepClosingSlash: true,
          minifyJS: true,
          minifyCSS: true,
          minifyURLs: true
        } : false
      })
    ],
    
    devServer: {
      static: {
        directory: path.join(__dirname, 'src/frontend/public')
      },
      port: 3001,
      hot: true,
      open: true,
      historyApiFallback: true,
      compress: true,
      client: {
        overlay: {
          errors: true,
          warnings: false
        }
      },
      proxy: {
        '/api': {
          target: 'http://localhost:3000',
          changeOrigin: true,
          secure: false
        },
        '/socket.io': {
          target: 'http://localhost:3000',
          changeOrigin: true,
          ws: true
        }
      }
    },
    
    optimization: {
      splitChunks: {
        chunks: 'all',
        cacheGroups: {
          vendor: {
            test: /[\\/]node_modules[\\/]/,
            name: 'vendors',
            chunks: 'all',
            priority: 10
          },
          common: {
            name: 'common',
            minChunks: 2,
            chunks: 'all',
            priority: 5,
            reuseExistingChunk: true
          }
        }
      },
      runtimeChunk: {
        name: 'runtime'
      }
    },
    
    devtool: isProduction ? 'source-map' : 'eval-source-map',
    
    performance: {
      hints: isProduction ? 'warning' : false,
      maxEntrypointSize: 512000,
      maxAssetSize: 512000
    },
    
    stats: {
      colors: true,
      modules: false,
      children: false,
      chunks: false,
      chunkModules: false
    }
  };
};

          
åˆ›å»ºBabelé…ç½®æ–‡ä»¶ï¼Œç”¨äºJavaScriptå’ŒReactä»£ç çš„è½¬è¯‘ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/.babelrc
          
content: {
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "browsers": ["> 1%", "last 2 versions", "not ie <= 8"]
        },
        "useBuiltIns": "usage",
        "corejs": 3,
        "modules": false
      }
    ],
    [
      "@babel/preset-react",
      {
        "runtime": "automatic",
        "development": true
      }
    ]
  ],
  "plugins": [],
  "env": {
    "development": {
      "plugins": [
        // å¼€å‘ç¯å¢ƒæ’ä»¶
      ]
    },
    "production": {
      "plugins": [
        // ç”Ÿäº§ç¯å¢ƒæ’ä»¶
      ]
    },
    "test": {
      "presets": [
        [
          "@babel/preset-env",
          {
            "targets": {
              "node": "current"
            }
          }
        ],
        [
          "@babel/preset-react",
          {
            "runtime": "automatic"
          }
        ]
      ]
    }
  }
}

          
åˆ›å»ºç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶ï¼ŒåŒ…å«é«˜å¾·åœ°å›¾APIé…ç½®ã€‚
        
            
toolName: edit_file_update
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/env.example
          
changes: 
              
newStr: # é«˜å¾·åœ°å›¾APIé…ç½®
REACT_APP_AMAP_API_KEY=your_amap_api_key_here
REACT_APP_AMAP_SECURITY_CODE=your_amap_security_code_here

# APIæœåŠ¡é…ç½®
REACT_APP_API_BASE_URL=http://localhost:3000
REACT_APP_WS_URL=ws://localhost:3000

# MQTTé…ç½®
REACT_APP_MQTT_BROKER=ws://localhost:8083/mqtt
              
oldStr: # Google Maps API Configuration
GOOGLE_MAPS_API_KEY=your_google_maps_api_key_here
GOOGLE_MAPS_LIBRARIES=places,geometry
            
          
åˆ›å»ºä¸€ä¸ªç®€å•çš„åç«¯APIæœåŠ¡å™¨ï¼Œæä¾›é…ç½®æ¥å£å’ŒWebSocketè¿æ¥ï¼Œç”¨äºä¸å‰ç«¯é›†æˆã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/src/backend/index.js
          
content: const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const path = require('path');
require('dotenv').config();

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: process.env.FRONTEND_URL || "http://localhost:3001",
    methods: ["GET", "POST"]
  }
});

const PORT = process.env.PORT || 3000;

// ä¸­é—´ä»¶
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '../frontend/public')));

// æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
const mockDevices = new Map();

// åˆå§‹åŒ–æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
function initializeMockDevices() {
  const deviceIds = ['device_001', 'device_002', 'device_003', 'device_004', 'device_005'];
  
  deviceIds.forEach((deviceId, index) => {
    mockDevices.set(deviceId, {
      id: deviceId,
      status: ['online', 'offline', 'warning'][Math.floor(Math.random() * 3)],
      locations: generateMockLocationHistory(deviceId, 50),
      lastUpdate: Date.now()
    });
  });
}

// ç”Ÿæˆæ¨¡æ‹Ÿä½ç½®å†å²æ•°æ®
function generateMockLocationHistory(deviceId, count) {
  const locations = [];
  const baseLocation = {
    lat: 39.9042 + (Math.random() - 0.5) * 0.1, // åŒ—äº¬é™„è¿‘
    lng: 116.4074 + (Math.random() - 0.5) * 0.1
  };
  
  for (let i = 0; i < count; i++) {
    const timestamp = Date.now() - (count - i) * 60000; // æ¯åˆ†é’Ÿä¸€ä¸ªç‚¹
    locations.push({
      lat: baseLocation.lat + (Math.random() - 0.5) * 0.01,
      lng: baseLocation.lng + (Math.random() - 0.5) * 0.01,
      timestamp,
      speed: Math.random() * 60, // 0-60 km/h
      heading: Math.random() * 360 // 0-360åº¦
    });
  }
  
  return locations;
}

// APIè·¯ç”±

// è·å–é…ç½®ä¿¡æ¯
app.get('/api/config', (req, res) => {
  const config = {
    amap: {
      api_key: process.env.REACT_APP_AMAP_API_KEY || 'YOUR_AMAP_API_KEY',
      security_js_code: process.env.REACT_APP_AMAP_SECURITY_CODE || 'YOUR_AMAP_SECURITY_CODE',
      version: '2.0',
      plugins: ['AMap.Scale', 'AMap.ToolBar', 'AMap.Geocoder', 'AMap.PlaceSearch'],
      default_center: {
        lng: 116.4074,
        lat: 39.9042
      },
      default_zoom: 12,
      map_style: 'amap://styles/normal',
      view_mode: '3D'
    },
    api: {
      base_url: process.env.REACT_APP_API_BASE_URL || 'http://localhost:3000',
      timeout: 10000
    },
    websocket: {
      url: process.env.REACT_APP_WS_URL || 'ws://localhost:3000',
      reconnect_interval: 5000,
      max_reconnect_attempts: 10
    },
    iot: {
      mqtt_broker: process.env.REACT_APP_MQTT_BROKER || 'ws://localhost:8083/mqtt',
      topics: {
        device_location: 'iot/device/+/location',
        device_status: 'iot/device/+/status',
        system_alerts: 'iot/system/alerts'
      }
    }
  };
  
  res.json(config);
});

// è·å–æ‰€æœ‰è®¾å¤‡ä¿¡æ¯
app.get('/api/devices', (req, res) => {
  const devices = Array.from(mockDevices.values());
  res.json(devices);
});

// è·å–ç‰¹å®šè®¾å¤‡ä¿¡æ¯
app.get('/api/devices/:deviceId', (req, res) => {
  const device = mockDevices.get(req.params.deviceId);
  if (!device) {
    return res.status(404).json({ error: 'è®¾å¤‡æœªæ‰¾åˆ°' });
  }
  res.json(device);
});

// è·å–è®¾å¤‡å†å²ä½ç½®æ•°æ®
app.get('/api/devices/:deviceId/history', (req, res) => {
  const device = mockDevices.get(req.params.deviceId);
  if (!device) {
    return res.status(404).json({ error: 'è®¾å¤‡æœªæ‰¾åˆ°' });
  }
  
  const { startTime, endTime, limit = 100 } = req.query;
  let locations = device.locations;
  
  // æ—¶é—´è¿‡æ»¤
  if (startTime || endTime) {
    locations = locations.filter(loc => {
      if (startTime && loc.timestamp < parseInt(startTime)) return false;
      if (endTime && loc.timestamp > parseInt(endTime)) return false;
      return true;
    });
  }
  
  // é™åˆ¶æ•°é‡
  if (limit) {
    locations = locations.slice(-parseInt(limit));
  }
  
  res.json({
    deviceId: req.params.deviceId,
    locations,
    total: locations.length
  });
});

// WebSocketè¿æ¥å¤„ç†
io.on('connection', (socket) => {
  console.log('å®¢æˆ·ç«¯å·²è¿æ¥:', socket.id);
  
  // å‘é€åˆå§‹è®¾å¤‡æ•°æ®
  socket.emit('initial_data', {
    devices: Array.from(mockDevices.values())
  });
  
  // å¤„ç†å†å²æ•°æ®è¯·æ±‚
  socket.on('request_historical_data', (data) => {
    const { deviceId, startTime, endTime } = data;
    const device = mockDevices.get(deviceId);
    
    if (device) {
      let locations = device.locations;
      
      // æ—¶é—´è¿‡æ»¤
      if (startTime || endTime) {
        locations = locations.filter(loc => {
          if (startTime && loc.timestamp < startTime) return false;
          if (endTime && loc.timestamp > endTime) return false;
          return true;
        });
      }
      
      socket.emit('message', {
        type: 'historical_data',
        data: {
          deviceId,
          locations
        }
      });
    }
  });
  
  // å¤„ç†è®¾å¤‡å‘½ä»¤
  socket.on('device_command', (data) => {
    const { deviceId, command, params } = data;
    console.log(`æ”¶åˆ°è®¾å¤‡å‘½ä»¤: ${deviceId} - ${command}`, params);
    
    // æ¨¡æ‹Ÿå‘½ä»¤æ‰§è¡Œç»“æœ
    socket.emit('message', {
      type: 'command_result',
      data: {
        deviceId,
        command,
        success: true,
        message: 'å‘½ä»¤æ‰§è¡ŒæˆåŠŸ',
        timestamp: Date.now()
      }
    });
  });
  
  socket.on('disconnect', () => {
    console.log('å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥:', socket.id);
  });
});

// æ¨¡æ‹Ÿå®æ—¶æ•°æ®æ›´æ–°
function simulateRealTimeData() {
  setInterval(() => {
    mockDevices.forEach((device, deviceId) => {
      // éšæœºæ›´æ–°è®¾å¤‡ä½ç½®
      if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ›´æ–°
        const lastLocation = device.locations[device.locations.length - 1];
        const newLocation = {
          lat: lastLocation.lat + (Math.random() - 0.5) * 0.001,
          lng: lastLocation.lng + (Math.random() - 0.5) * 0.001,
          timestamp: Date.now(),
          speed: Math.random() * 60,
          heading: Math.random() * 360
        };
        
        device.locations.push(newLocation);
        
        // ä¿æŒæœ€è¿‘100ä¸ªä½ç½®ç‚¹
        if (device.locations.length > 100) {
          device.locations = device.locations.slice(-100);
        }
        
        device.lastUpdate = Date.now();
        
        // å¹¿æ’­ä½ç½®æ›´æ–°
        io.emit('message', {
          type: 'device_location_update',
          data: {
            deviceId,
            location: newLocation,
            timestamp: newLocation.timestamp,
            device
          }
        });
      }
      
      // éšæœºæ›´æ–°è®¾å¤‡çŠ¶æ€
      if (Math.random() < 0.05) { // 5%æ¦‚ç‡æ›´æ–°çŠ¶æ€
        const statuses = ['online', 'offline', 'warning'];
        const newStatus = statuses[Math.floor(Math.random() * statuses.length)];
        
        if (device.status !== newStatus) {
          device.status = newStatus;
          device.lastUpdate = Date.now();
          
          // å¹¿æ’­çŠ¶æ€æ›´æ–°
          io.emit('message', {
            type: 'device_status_update',
            data: {
              deviceId,
              status: newStatus,
              timestamp: Date.now(),
              device
            }
          });
        }
      }
    });
  }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
}

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((err, req, res, next) => {
  console.error('æœåŠ¡å™¨é”™è¯¯:', err);
  res.status(500).json({ error: 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯' });
});

// 404å¤„ç†
app.use((req, res) => {
  res.status(404).json({ error: 'æ¥å£æœªæ‰¾åˆ°' });
});

// å¯åŠ¨æœåŠ¡å™¨
server.listen(PORT, () => {
  console.log(`ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
  console.log(`ğŸ“ APIåœ°å€: http://localhost:${PORT}/api`);
  console.log(`ğŸ”Œ WebSocketåœ°å€: ws://localhost:${PORT}`);
  
  // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
  initializeMockDevices();
  
  // å¼€å§‹æ¨¡æ‹Ÿå®æ—¶æ•°æ®
  simulateRealTimeData();
  
  console.log('âœ… æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®å·²åˆå§‹åŒ–');
  console.log(`ğŸ“Š æ¨¡æ‹Ÿè®¾å¤‡æ•°é‡: ${mockDevices.size}`);
});

// ä¼˜é›…å…³é—­
process.on('SIGTERM', () => {
  console.log('æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');
  server.close(() => {
    console.log('æœåŠ¡å™¨å·²å…³é—­');
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('æ”¶åˆ°SIGINTä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');
  server.close(() => {
    console.log('æœåŠ¡å™¨å·²å…³é—­');
    process.exit(0);
  });
});

          
åˆ›å»ºä¸€ä¸ªREADMEæ–‡ä»¶ï¼Œè¯´æ˜å¦‚ä½•è¿è¡Œå’Œä½¿ç”¨è¿™ä¸ªé«˜å¾·åœ°å›¾å‰ç«¯åº”ç”¨ã€‚
        
            
toolName: write_to_file
            
status: success
          
            
filePath: /Users/arthurren/projects/lbsiot/FRONTEND_README.md
          
content: # LBS IoT å‰ç«¯åº”ç”¨ - é«˜å¾·åœ°å›¾é›†æˆ

åŸºäºReactå’Œé«˜å¾·åœ°å›¾APIçš„ç‰©è”ç½‘è®¾å¤‡ä½ç½®å¯è§†åŒ–å‰ç«¯åº”ç”¨ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶ï¼š
```bash
cp env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®é«˜å¾·åœ°å›¾APIå¯†é’¥ï¼š
```env
# é«˜å¾·åœ°å›¾APIé…ç½®
REACT_APP_AMAP_API_KEY=your_amap_api_key_here
REACT_APP_AMAP_SECURITY_CODE=your_amap_security_code_here

# APIæœåŠ¡é…ç½®
REACT_APP_API_BASE_URL=http://localhost:3000
REACT_APP_WS_URL=ws://localhost:3000

# MQTTé…ç½®
REACT_APP_MQTT_BROKER=ws://localhost:8083/mqtt
```

### 3. è·å–é«˜å¾·åœ°å›¾APIå¯†é’¥

1. è®¿é—® [é«˜å¾·å¼€æ”¾å¹³å°](https://lbs.amap.com/)
2. æ³¨å†Œå¹¶ç™»å½•è´¦å·
3. åˆ›å»ºåº”ç”¨ï¼Œé€‰æ‹©ã€ŒWebç«¯(JS API)ã€
4. è·å–API Keyå’Œå®‰å…¨å¯†é’¥
5. å°†å¯†é’¥é…ç½®åˆ° `.env` æ–‡ä»¶ä¸­

### 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

#### æ–¹å¼ä¸€ï¼šåŒæ—¶å¯åŠ¨å‰åç«¯
```bash
npm run dev:all
```

#### æ–¹å¼äºŒï¼šåˆ†åˆ«å¯åŠ¨
```bash
# å¯åŠ¨åç«¯APIæœåŠ¡å™¨ (ç«¯å£3000)
npm run dev:backend

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ (ç«¯å£3001)
npm run dev:frontend
```

### 5. è®¿é—®åº”ç”¨

- å‰ç«¯åº”ç”¨: http://localhost:3001
- åç«¯API: http://localhost:3000/api

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/frontend/
â”œâ”€â”€ components/          # Reactç»„ä»¶
â”‚   â””â”€â”€ AmapComponent.jsx   # é«˜å¾·åœ°å›¾ç»„ä»¶
â”œâ”€â”€ services/           # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ AmapService.js     # é«˜å¾·åœ°å›¾æœåŠ¡
â”‚   â”œâ”€â”€ ConfigService.js   # é…ç½®æœåŠ¡
â”‚   â””â”€â”€ IoTDataService.js  # IoTæ•°æ®æœåŠ¡
â”œâ”€â”€ pages/              # é¡µé¢ç»„ä»¶
â”‚   â””â”€â”€ MapPage.jsx        # åœ°å›¾ä¸»é¡µé¢
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”œâ”€â”€ assets/             # é™æ€èµ„æº
â”œâ”€â”€ public/             # å…¬å…±æ–‡ä»¶
â”‚   â””â”€â”€ index.html         # HTMLæ¨¡æ¿
â”œâ”€â”€ App.jsx             # ä¸»åº”ç”¨ç»„ä»¶
â”œâ”€â”€ App.css             # åº”ç”¨æ ·å¼
â”œâ”€â”€ index.js            # åº”ç”¨å…¥å£
â””â”€â”€ index.css           # åŸºç¡€æ ·å¼
```

## ğŸ—ºï¸ åŠŸèƒ½ç‰¹æ€§

### åœ°å›¾åŠŸèƒ½
- âœ… é«˜å¾·åœ°å›¾åˆå§‹åŒ–å’Œæ˜¾ç¤º
- âœ… è®¾å¤‡ä½ç½®æ ‡è®°æ˜¾ç¤º
- âœ… æ—¶é—´åºåˆ—è½¨è¿¹ç»˜åˆ¶
- âœ… åœ°å›¾æ§ä»¶ï¼ˆç¼©æ”¾ã€å·¥å…·æ ï¼‰
- âœ… ä¿¡æ¯çª—å£æ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…
- âœ… åœ°ç†ç¼–ç å’Œé€†åœ°ç†ç¼–ç 
- âœ… POIæœç´¢åŠŸèƒ½

### IoTæ•°æ®åŠŸèƒ½
- âœ… å®æ—¶è®¾å¤‡ä½ç½®æ›´æ–°
- âœ… è®¾å¤‡çŠ¶æ€ç›‘æ§
- âœ… å†å²è½¨è¿¹æŸ¥è¯¢
- âœ… WebSocketå®æ—¶é€šä¿¡
- âœ… MQTTæ¶ˆæ¯å¤„ç†ï¼ˆæ¨¡æ‹Ÿï¼‰
- âœ… è®¾å¤‡åˆ—è¡¨ç®¡ç†

### ç”¨æˆ·ç•Œé¢
- âœ… å“åº”å¼è®¾è®¡
- âœ… è®¾å¤‡é¢æ¿ä¾§è¾¹æ 
- âœ… å®æ—¶è¿æ¥çŠ¶æ€æ˜¾ç¤º
- âœ… æ—¶é—´èŒƒå›´é€‰æ‹©
- âœ… è®¾å¤‡ç­›é€‰å’Œæœç´¢
- âœ… å·¥å…·æ æ“ä½œ

## ğŸ”§ å¼€å‘å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æ¨¡å¼ï¼ˆå‰åç«¯åŒæ—¶å¯åŠ¨ï¼‰
npm run dev:all

# ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
npm run dev:frontend

# ä»…å¯åŠ¨åç«¯æœåŠ¡å™¨
npm run dev:backend

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build:frontend

# è¿è¡Œæµ‹è¯•
npm run test:frontend

# ä»£ç æ£€æŸ¥
npm run lint

# ä»£ç æ ¼å¼åŒ–
npm run lint:fix

# æ¸…ç†æ„å»ºæ–‡ä»¶
npm run clean
```

## ğŸŒ APIæ¥å£

### é…ç½®æ¥å£
- `GET /api/config` - è·å–åº”ç”¨é…ç½®

### è®¾å¤‡æ¥å£
- `GET /api/devices` - è·å–æ‰€æœ‰è®¾å¤‡
- `GET /api/devices/:deviceId` - è·å–ç‰¹å®šè®¾å¤‡ä¿¡æ¯
- `GET /api/devices/:deviceId/history` - è·å–è®¾å¤‡å†å²ä½ç½®

### WebSocketäº‹ä»¶
- `device_location_update` - è®¾å¤‡ä½ç½®æ›´æ–°
- `device_status_update` - è®¾å¤‡çŠ¶æ€æ›´æ–°
- `historical_data` - å†å²æ•°æ®å“åº”
- `system_alert` - ç³»ç»Ÿå‘Šè­¦

## ğŸ“± ä½¿ç”¨è¯´æ˜

### 1. æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨
- å·¦ä¾§é¢æ¿æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿è®¾å¤‡
- è®¾å¤‡çŠ¶æ€ç”¨é¢œè‰²åŒºåˆ†ï¼ˆç»¿è‰²=åœ¨çº¿ï¼Œçº¢è‰²=ç¦»çº¿ï¼Œé»„è‰²=å‘Šè­¦ï¼‰
- æ˜¾ç¤ºè®¾å¤‡ä½ç½®ç‚¹æ•°é‡å’Œæœ€åæ›´æ–°æ—¶é—´

### 2. æŸ¥çœ‹è®¾å¤‡è½¨è¿¹
- ç‚¹å‡»è®¾å¤‡åˆ—è¡¨ä¸­çš„è®¾å¤‡
- åœ°å›¾ä¸Šä¼šæ˜¾ç¤ºè¯¥è®¾å¤‡çš„å†å²è½¨è¿¹
- å¯ä»¥é€‰æ‹©ä¸åŒçš„æ—¶é—´èŒƒå›´ï¼ˆ1å°æ—¶ã€6å°æ—¶ã€24å°æ—¶ã€7å¤©ï¼‰

### 3. åœ°å›¾æ“ä½œ
- é¼ æ ‡æ»šè½®ç¼©æ”¾åœ°å›¾
- æ‹–æ‹½ç§»åŠ¨åœ°å›¾è§†è§’
- ç‚¹å‡»è®¾å¤‡æ ‡è®°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
- ä½¿ç”¨å·¥å…·æ æŒ‰é’®æ§åˆ¶æ˜¾ç¤º

### 4. å®æ—¶ç›‘æ§
- è®¾å¤‡ä½ç½®ä¼šå®æ—¶æ›´æ–°
- è¿æ¥çŠ¶æ€æ˜¾ç¤ºåœ¨è®¾å¤‡é¢æ¿é¡¶éƒ¨
- æ–°çš„ä½ç½®ç‚¹ä¼šè‡ªåŠ¨æ·»åŠ åˆ°è½¨è¿¹ä¸­

## ğŸ”§ é…ç½®è¯´æ˜

### é«˜å¾·åœ°å›¾é…ç½®
```javascript
{
  api_key: 'your_api_key',           // APIå¯†é’¥
  security_js_code: 'your_code',     // å®‰å…¨å¯†é’¥
  version: '2.0',                    // APIç‰ˆæœ¬
  plugins: [...],                    // æ’ä»¶åˆ—è¡¨
  default_center: { lng, lat },      // é»˜è®¤ä¸­å¿ƒç‚¹
  default_zoom: 12,                  // é»˜è®¤ç¼©æ”¾çº§åˆ«
  map_style: 'amap://styles/normal', // åœ°å›¾æ ·å¼
  view_mode: '3D'                    // è§†å›¾æ¨¡å¼
}
```

### WebSocketé…ç½®
```javascript
{
  url: 'ws://localhost:3000',        // WebSocketåœ°å€
  reconnect_interval: 5000,          // é‡è¿é—´éš”
  max_reconnect_attempts: 10         // æœ€å¤§é‡è¿æ¬¡æ•°
}
```

## ğŸ› æ•…éšœæ’é™¤

### 1. åœ°å›¾æ— æ³•åŠ è½½
- æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®
- ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### 2. è®¾å¤‡æ•°æ®ä¸æ˜¾ç¤º
- ç¡®è®¤åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
- æŸ¥çœ‹ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ

### 3. æ„å»ºå¤±è´¥
- åˆ é™¤ `node_modules` æ–‡ä»¶å¤¹
- é‡æ–°è¿è¡Œ `npm install`
- æ£€æŸ¥Node.jsç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Node.js >= 16.0.0
- npm >= 8.0.0
- ç°ä»£æµè§ˆå™¨ï¼ˆChrome, Firefox, Safari, Edgeï¼‰

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ†˜ æ”¯æŒ

å¦‚æœæ‚¨é‡åˆ°é—®é¢˜æˆ–æœ‰ç–‘é—®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æœç´¢ç°æœ‰çš„ [Issues](https://github.com/your-repo/issues)
3. åˆ›å»ºæ–°çš„ Issue æè¿°æ‚¨çš„é—®é¢˜

## ğŸ”— ç›¸å…³é“¾æ¥

- [é«˜å¾·åœ°å›¾å¼€æ”¾å¹³å°](https://lbs.amap.com/)
- [é«˜å¾·åœ°å›¾JS APIæ–‡æ¡£](https://lbs.amap.com/api/jsapi-v2/summary)
- [Reactå®˜æ–¹æ–‡æ¡£](https://reactjs.org/)
- [Socket.IOæ–‡æ¡£](https://socket.io/docs/)

          
âœ… **é«˜å¾·åœ°å›¾Webå‰ç«¯æ¸²æŸ“ç³»ç»Ÿå·²å®Œæˆå®ç°**

## ğŸ¯ å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. é«˜å¾·åœ°å›¾é›†æˆ
- **<mcfile name="AmapService.js" path="/Users/arthurren/projects/lbsiot/src/frontend/services/AmapService.js"></mcfile>**: é«˜å¾·åœ°å›¾æ ¸å¿ƒæœåŠ¡ç±»ï¼Œæä¾›åœ°å›¾åˆå§‹åŒ–ã€æ ‡è®°ç®¡ç†ã€è·¯å¾„ç»˜åˆ¶ç­‰åŠŸèƒ½
- **<mcfile name="AmapComponent.jsx" path="/Users/arthurren/projects/lbsiot/src/frontend/components/AmapComponent.jsx"></mcfile>**: Reactåœ°å›¾ç»„ä»¶ï¼Œæ”¯æŒæ ‡è®°ç‚¹æ˜¾ç¤ºã€æ—¶é—´åºåˆ—è·¯å¾„ç»˜åˆ¶ã€POIæœç´¢
- æ”¯æŒåœ°ç†ç¼–ç ã€é€†åœ°ç†ç¼–ç ã€å®æ—¶ä½ç½®æ›´æ–°
- é›†æˆåœ°å›¾æ§ä»¶ï¼ˆç¼©æ”¾ã€å·¥å…·æ ã€ä¿¡æ¯çª—å£ï¼‰

### 2. IoTæ•°æ®æœåŠ¡
- **<mcfile name="IoTDataService.js" path="/Users/arthurren/projects/lbsiot/src/frontend/services/IoTDataService.js"></mcfile>**: IoTæ•°æ®ç®¡ç†æœåŠ¡ï¼Œå¤„ç†è®¾å¤‡ä½ç½®æ•°æ®å’ŒMQTTé€šä¿¡
- **<mcfile name="ConfigService.js" path="/Users/arthurren/projects/lbsiot/src/frontend/services/ConfigService.js"></mcfile>**: é…ç½®ç®¡ç†æœåŠ¡ï¼Œæ”¯æŒç¯å¢ƒå˜é‡å’ŒåŠ¨æ€é…ç½®åŠ è½½
- å®æ—¶WebSocketè¿æ¥å’Œæ•°æ®æ›´æ–°
- è®¾å¤‡çŠ¶æ€ç›‘æ§å’Œå†å²è½¨è¿¹æŸ¥è¯¢

### 3. ç”¨æˆ·ç•Œé¢
- **<mcfile name="MapPage.jsx" path="/Users/arthurren/projects/lbsiot/src/frontend/pages/MapPage.jsx"></mcfile>**: ä¸»åœ°å›¾é¡µé¢ï¼Œé›†æˆè®¾å¤‡é¢æ¿å’Œå®æ—¶ç›‘æ§
- **<mcfile name="App.jsx" path="/Users/arthurren/projects/lbsiot/src/frontend/App.jsx"></mcfile>**: åº”ç”¨å…¥å£å’Œè·¯ç”±é…ç½®
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒè®¾å¤‡åˆ—è¡¨ã€æ—¶é—´èŒƒå›´é€‰æ‹©ã€å®æ—¶çŠ¶æ€æ˜¾ç¤º
- ç°ä»£åŒ–UIæ ·å¼å’Œäº¤äº’ä½“éªŒ

### 4. å¼€å‘ç¯å¢ƒé…ç½®
- **<mcfile name="webpack.config.js" path="/Users/arthurren/projects/lbsiot/webpack.config.js"></mcfile>**: Webpackæ„å»ºé…ç½®ï¼Œæ”¯æŒå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ
- **<mcfile name=".babelrc" path="/Users/arthurren/projects/lbsiot/.babelrc"></mcfile>**: Babelè½¬è¯‘é…ç½®ï¼Œæ”¯æŒReactå’ŒES6+
- **<mcfile name="package.json" path="/Users/arthurren/projects/lbsiot/package.json"></mcfile>**: æ›´æ–°ä¾èµ–åŒ…ï¼Œæ·»åŠ Reactã€é«˜å¾·åœ°å›¾ç›¸å…³åº“
- å¼€å‘æœåŠ¡å™¨é…ç½®ï¼Œæ”¯æŒçƒ­é‡è½½å’ŒAPIä»£ç†

### 5. åç«¯APIæœåŠ¡
- **<mcfile name="index.js" path="/Users/arthurren/projects/lbsiot/src/backend/index.js"></mcfile>**: ExpressæœåŠ¡å™¨ï¼Œæä¾›é…ç½®æ¥å£å’ŒWebSocketè¿æ¥
- æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®ç”Ÿæˆå’Œå®æ—¶æ›´æ–°
- RESTful APIæ¥å£å’ŒWebSocketäº‹ä»¶å¤„ç†

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. é…ç½®é«˜å¾·åœ°å›¾API
```bash
cp env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œæ·»åŠ é«˜å¾·åœ°å›¾APIå¯†é’¥
```

### 3. å¯åŠ¨åº”ç”¨
```bash
# åŒæ—¶å¯åŠ¨å‰åç«¯
npm run dev:all

# æˆ–åˆ†åˆ«å¯åŠ¨
npm run dev:backend  # åç«¯API (ç«¯å£3000)
npm run dev:frontend # å‰ç«¯åº”ç”¨ (ç«¯å£3001)
```

### 4. è®¿é—®åº”ç”¨
- å‰ç«¯: http://localhost:3001
- åç«¯API: http://localhost:3000/api

## ğŸ“‹ ä¸‹ä¸€æ­¥å»ºè®®

### ç¬¬äºŒé˜¶æ®µï¼šåå°æ¥å£æœåŠ¡ä¼˜åŒ–
1. **æ•°æ®åº“é›†æˆ**: è¿æ¥MongoDBå­˜å‚¨è®¾å¤‡å’Œä½ç½®æ•°æ®
2. **ç”¨æˆ·è®¤è¯**: å®ç°JWTè®¤è¯å’Œæƒé™ç®¡ç†
3. **APIä¼˜åŒ–**: æ·»åŠ åˆ†é¡µã€è¿‡æ»¤ã€æ’åºåŠŸèƒ½
4. **ç¼“å­˜æœºåˆ¶**: ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®

### ç¬¬ä¸‰é˜¶æ®µï¼šIoT MQTTäº‹ä»¶æ¥å£
1. **MQTT Broker**: é›†æˆçœŸå®çš„MQTTæœåŠ¡å™¨
2. **è®¾å¤‡åè®®**: å®ç°æ ‡å‡†IoTè®¾å¤‡é€šä¿¡åè®®
3. **æ—¶åºæ•°æ®åº“**: ä½¿ç”¨InfluxDBå­˜å‚¨ä½ç½®æ—¶åºæ•°æ®
4. **å®æ—¶å‘Šè­¦**: å®ç°åœ°ç†å›´æ å’Œå¼‚å¸¸æ£€æµ‹

## ğŸ‰ æŠ€æœ¯äº®ç‚¹

- **é«˜å¾·åœ°å›¾æ›¿ä»£Google Maps**: å®Œç¾é€‚é…ä¸­å›½åœ°åŒºä½¿ç”¨
- **æ¨¡å—åŒ–æ¶æ„**: æœåŠ¡å±‚åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **å®æ—¶æ•°æ®æµ**: WebSocket + æ¨¡æ‹ŸMQTTå®ç°å®æ—¶æ›´æ–°
- **å“åº”å¼è®¾è®¡**: æ”¯æŒæ¡Œé¢å’Œç§»åŠ¨ç«¯è®¿é—®
- **å¼€å‘å‹å¥½**: çƒ­é‡è½½ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ç›‘æ§

é«˜å¾·åœ°å›¾å‰ç«¯ç³»ç»Ÿå·²å®Œæ•´å®ç°ï¼Œå…·å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²èƒ½åŠ›ã€‚è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ **<mcfile name="FRONTEND_README.md" path="/Users/arthurren/projects/lbsiot/FRONTEND_README.md"></mcfile>**ã€‚

---

## ğŸ”§ WebSocketè¿æ¥ä¿®å¤ (2025-01-09 æ™šé—´)

### é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆWebSocketè¿æ¥å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦å°†åŸç”ŸWebSocketè¿æ¥å‡çº§ä¸ºSocket.IOä»¥æä¾›æ›´å¥½çš„è¿æ¥ç¨³å®šæ€§å’Œè‡ªåŠ¨é‡è¿åŠŸèƒ½ã€‚

### è§£å†³æ–¹æ¡ˆ

#### 1. å‰ç«¯ä¾èµ–å‡çº§
- å®‰è£… `socket.io-client` ä¾èµ–åŒ…
- æ›´æ–°å‰ç«¯WebSocketè¿æ¥å®ç°

#### 2. IoTDataService é‡æ„
ä¿®æ”¹ **<mcfile name="IoTDataService.js" path="/Users/arthurren/projects/lbsiot/src/frontend/services/IoTDataService.js"></mcfile>**:

- **è¿æ¥æ–¹å¼å‡çº§**: å°†åŸç”ŸWebSocket (`new WebSocket()`) æ›¿æ¢ä¸ºSocket.IOå®¢æˆ·ç«¯ (`io()`)
- **äº‹ä»¶ç›‘å¬æ›´æ–°**: æ›´æ–°äº‹ä»¶ç›‘å¬æ–¹å¼ï¼Œå¤„ç† `connect`ã€`device_location_update`ã€`device_status_update`ã€`system_alert`ã€`historical_data`ã€`disconnect`ã€`connect_error` ç­‰äº‹ä»¶
- **æ¶ˆæ¯å‘é€ä¼˜åŒ–**: å°† `websocket.send()` æ–¹æ³•æ›¿æ¢ä¸º `socket.emit()` æ–¹æ³•
- **è¿æ¥çŠ¶æ€ç®¡ç†**: æ›´æ–°è¿æ¥çŠ¶æ€æ£€æŸ¥é€»è¾‘ï¼Œä½¿ç”¨Socket.IOçš„è¿æ¥çŠ¶æ€
- **æ–­å¼€è¿æ¥å¤„ç†**: å°† `websocket.close()` æ›¿æ¢ä¸º `socket.disconnect()`

#### 3. å…·ä½“ä¿®æ”¹å†…å®¹

**è¿æ¥å»ºç«‹**:
```javascript
// åŸæ¥: this.websocket = new WebSocket(url)
// ç°åœ¨: this.socket = io(url, options)
```

**äº‹ä»¶ç›‘å¬**:
```javascript
// åŸæ¥: this.websocket.onmessage = (event) => {}
// ç°åœ¨: this.socket.on('device_location_update', (data) => {})
```

**æ¶ˆæ¯å‘é€**:
```javascript
// åŸæ¥: this.websocket.send(JSON.stringify(message))
// ç°åœ¨: this.socket.emit('request_historical_data', data)
```

**è¿æ¥æ–­å¼€**:
```javascript
// åŸæ¥: this.websocket.close()
// ç°åœ¨: this.socket.disconnect()
```

### æŠ€æœ¯ä¼˜åŠ¿

1. **è‡ªåŠ¨é‡è¿**: Socket.IOæä¾›å†…ç½®çš„è‡ªåŠ¨é‡è¿æœºåˆ¶
2. **è¿æ¥ç¨³å®šæ€§**: æ›´å¥½çš„ç½‘ç»œå¼‚å¸¸å¤„ç†å’Œæ¢å¤èƒ½åŠ›
3. **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„é€šä¿¡æ¨¡å¼ï¼Œä»£ç æ›´æ¸…æ™°
4. **è·¨æµè§ˆå™¨å…¼å®¹**: Socket.IOæä¾›æ›´å¥½çš„æµè§ˆå™¨å…¼å®¹æ€§
5. **è°ƒè¯•å‹å¥½**: æ›´è¯¦ç»†çš„è¿æ¥çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

### éƒ¨ç½²éªŒè¯

- âœ… åç«¯æœåŠ¡æˆåŠŸå¯åŠ¨ (ç«¯å£3000)
- âœ… å‰ç«¯æœåŠ¡æˆåŠŸå¯åŠ¨ (ç«¯å£3001) 
- âœ… Socket.IOå®¢æˆ·ç«¯è¿æ¥æ­£å¸¸
- âœ… å®æ—¶æ•°æ®ä¼ è¾“åŠŸèƒ½æ­£å¸¸
- âœ… é¢„è§ˆé¡µé¢å¯æ­£å¸¸è®¿é—®

### å½±å“èŒƒå›´
- **å‰ç«¯æœåŠ¡**: IoTDataService.js å®Œå…¨é‡æ„
- **ä¾èµ–ç®¡ç†**: æ–°å¢ socket.io-client ä¾èµ–
- **è¿æ¥åè®®**: ä»åŸç”ŸWebSocketå‡çº§åˆ°Socket.IO
- **å‘åå…¼å®¹**: ä¿æŒAPIæ¥å£ä¸å˜ï¼Œå¯¹ä¸Šå±‚ç»„ä»¶é€æ˜

WebSocketè¿æ¥ä¿®å¤å®Œæˆï¼Œç³»ç»Ÿè¿æ¥ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒå¾—åˆ°æ˜¾è‘—æå‡ã€‚
        